<!DOCTYPE html><html lang=en>
<head>
  <meta charset=utf-8>
  <meta http-equiv=x-ua-compatible content="ie=edge">
  <meta name=viewport content="initial-scale=1", shrink-to-fit=no, user-scalable=no>
  <title>URL Specification</title>
  <link rel=stylesheet href=style/base.css>
  <link rel=stylesheet href=style/style.css>
  <script src=lib/bnf.js></script>
  <script src=scripts/main.js></script>
</head>
<body>

<!----------------------------->

<header>
  <hgroup>
    <h2 class=toc-exclude><!----></h2>
  </hgroup>
</header>

<!----------------------------->

<div id=tools>
  <div id=menu>
    <a id=icon href=#url-specification>ðŸŒ²</a>
    <ul>
      <li><a href=#prelude>Prelude</a></li>
      <li><a href=#url-model><span class=url>URL</span> Model</a></li>
      <li><a href=#authority-model>Authority</a></li>
      <li><a href=#component-characters>Characters</a></li>
      <li><a href=#reference-resolution >Resolution</a></li>
      <li><a href=#parsing>Parsing</a></li>
      <li><a href=#equivalences-and-normalisation >Normalisation</a></li>
      <li><a href=#printing>Printing</a></li>
    </ul>
  </div>
  <div id=tooltip></div>
</div>


<!----------------------------->


<main>
<article>
<h1 id=url-specification>URL Specification</h1>


<section class=-short>

  <h2 id=goals class=toc-exclude style=display:none>URL Specification</h2>

  <p>
    This document provides a concise formal definition of <span class=url>URL</span>s and
    the language of <span class=url>URL</span>s. It offers a rephrasing of the 
    <a href="https://url.spec.whatwg.org/"><abbr class=caps>WHATWG URL</abbr>
      standard</a> in an effort to better reveal the internal structure of 
    <span class=url>URL</span>s and the operations on them.
    It provides a formal grammar and a set of elementary operations that are eventually
    combined together in such a way that the end result is equivalent with the
    <abbr class=caps>WHATWG</abbr> standard.

  <p class=inbetween>
    The goals of this project are:

  <ul>
    <li>
      To provide a modular, concise formal specification of <span class=url>URL</span>s
      that is behaviourally equivalent with, and  covers all of the
      <a href="https://url.spec.whatwg.org/"><abbr class=caps>WHATWG URL</abbr>
        standard</a> with the exception of the web <abbr class=caps>API</abbr>'s setters
      and the url-encoded form format.
    <li>
      To provide a general model for <span class=url>URL</span>s that can express
      relative references and to define reference resolution by means of a number of
      elementary operations, in such a way that the end result is  in agreement with
      the <abbr class=caps>WHATWG</abbr> standard.
    <li>
      To provide a concise way to describe the differences between the
      <abbr class=caps>WHATWG</abbr> standard and
      <a href="https://tools.ietf.org/html/rfc3986"><abbr class=caps>RFC</abbr>Â 3986</a>
      and
      <a href="https://tools.ietf.org/html/rfc3987"><abbr class=caps>RFC</abbr>Â 3987</a>
      as part of a larger effort;
    <li>
      To enable and support work towards an update of
      <a href="https://tools.ietf.org/html/rfc3987"><abbr class=caps>RFC</abbr>Â 3987</a>
      that resolves the incompatibilities with the <abbr class=caps>WHATWG</abbr>
      standard.
    <li>
      To enable and support editorial changes to the <abbr class=caps>WHATWG</abbr>
      standard in the hope to recover the structural framework for relative references,
      normalisation and the hierarchy of equivalence relations that was put forward in
      <a href="https://tools.ietf.org/html/rfc3986"><abbr class=caps>RFC</abbr>Â 3986</a>.
  </ul>

</section>


<!----------------------------->


<section class=-short>

  <h2 class=toc-exclude>Status</h2>

  <ul>
    <li>
      This is version 0.10.0 of the specification.
    <li>
      This document is licensed under a
      <a href="https://creativecommons.org/licenses/by-sa/2.0/">
      Creative Commons - <abbr class=caps>CC BY-SA</abbr> 2.0</a> license. 
    <li>
      Development can be discussed on
      <a href="https://github.com/alwinb/url-specification">GitHub</a>.
      Questions are welcome there as well.
    <li>
      There is a <a href="https://github.com/alwinb/spec-url">Reference Implementation</a>
      to accompany this specification.
    <li>
      The reference implementation <strong>passes all</strong> 
      the <span class=url>URL</span>-constructor tests  
      in the <a href=https://web-platform-tests.org>web-platform</a> test-suite.
  </ul>
</section>


<!----------------------------->


<section>

  <h2 id=prelude>Prelude</h2>

  <p>
    This section introduces basic concepts and notational conventions that are used
    throughout the rest of this document.

  <h4>Components</h4>
    <p>
      <dfn style=display:none>type</dfn><dfn style=display:none>value</dfn>
      The word <dfn>component</dfn> is used throughout this document to mean a
      tagged value, denoted by (<var>type</var> <var>value</var>), where
      <var>type</var> is taken from a predefined set of
      <dfn>component-type</dfn>s.

    <p>
      The <i>component-type</i> is typeset in boldface and it may be used stand-alone
      as a <i class=common>component-type</i> or in prefix position to denote a 
      <i>component</i>.

    <p>
      For example, <b class=noindex>scheme</b> denotes a <i>component-type</i>,
      whilst e.g. (<b class=noindex>scheme</b>Â <code>http</code>) denotes a
      <b class=noindex>scheme</b>-<i>component</i> that has the 
      string <code>http</code> as its value.

    <p>
      When we are dealing with a collection of <i class=common>component</i>s,
      and the collection contains exactly one <i class=common>component</i> with 
      a given <i class=common>component-type</i>, then we may use the type of
      the component to refer to its value directly.

    <p>
      For example, if S is a <i class=common>sequence</i> of
      <i class=common>component</i>s (<b class=noindex>dir</b> <var>x</var>ãƒ»<b
       class=noindex>file</b> <var>y</var>ãƒ»<b class=noindex>query</b> <var>z</var>) then
       the phrase &ldquo;the <b class=noindex>query</b> of S&rdquo; is used to refer to
       the <i class=common>value</i> <var>z</var> whereas
       &ldquo;the <b class=noindex>query</b> <i class=common>component</i> of S&rdquo;
       is used to refer to the <i class=common>component</i>
       (<b class=noindex>query</b>Â <var>z</var>) as a whole.

    <p class=dfn-scope>
      The <i class=noindex>value</i> of a <i class=common>component</i> may be a
      <i class=common>sequence</i> of <i class=common>component</i>s itself, in which case the
      <i class=common>component</i> may be referred to as a <dfn>compound-component</dfn> for clarity.
      <!--and the components present in its value may be referred to as
      <dfn>sub-component</dfn>s.-->

  <div class="dfn-scope +br">
  <h4>Sequences</h4>
    <p>
      This specification uses a notation for <dfn>sequence</dfn>s
      that makes no distinction between one-element sequences and single
      elements. It uses the following notation:
    <ul>
      <li>
        The empty sequence is denoted by Îµ. 
      <li>
        The concatenation of two sequences <var>S</var> and <var>T</var> is
        denoted by <var>S</var>ãƒ»<var>T</var>. 
    </ul>
  </div>

  <!-- <p>
    Furthermore, the notation
    <var>e</var>Â <b>:</b>Â <var>T</var> is used to denote the concatenation of a
    single-element <var>e</var> in front of a sequence <var>T</var>.

  <p>
    The notation <var>e</var>Â <b>:</b>Â <var>T</var> may be used to inductively specify
    operations on sequences. For example, the length of a sequence is defined by
    <dfn class=noindex>length</dfn>Â ÎµÂ =Â 0 and
    <dfn class=noindex>length</dfn>Â (<var>e</var> <b>:</b> <var>T</var>)Â =
    1Â +Â <i>length</i>Â <var>T</var>. -->

  <!-- <p style=margin-top:-.5rem>
    Parentheses are used for disambiguation and as visual aides. Paired
    parentheses are not part of a sequence-constructing operation.  -->


  <h4>Strings and Code-Points</h4>
    <p class=-br>
      For the purpose of this specification,
    <ul class=dfn-scope>
      <li>
        A <dfn>string</dfn> is a <i class=common>sequence</i> of
        <i>character</i>s.
      <li>
        A <dfn>character</dfn> is a single
        <a href="https://www.unicode.org/versions/latest/">Unicode</a>
        <i>code point</i>.
      <li>
        A <dfn>code point</dfn>, is a natural number
        <var>n</var>Â &lt;Â 17Â Ã—Â 2<sup>16</sup>.
      <li>
        The <dfn>empty string</dfn> is a <i class=common>sequence</i> of zero
        code points. It is denoted by Îµ. 
    </ul>
    <p>
      Code points are denoted by a number in <em>hexadecimal</em> notation preceded by
      <b class=noindex>u+</b>, in boldface. Code points that correspond to
      <i class=common>printable <abbr class=caps>ASCII</abbr> characters</i> are often
      denoted by their corresponding glyph, typeset in monospace and on a screened background.
      For example, <b>u+41</b> and <code>A</code> denote the same code point. Strings that
      contain only <i class=common>printable <abbr class=caps>ASCII</abbr> characters</i>
      are often denoted as a connected sequence of glyphs, typeset likewise.
    <p>
      The <dfn class=common>printable <abbr class=caps>ASCII</abbr> characters</dfn> are
      code points in the range <b>u+20</b> to <b>u+7E</b>, inclusive. Note that this includes
      the space <i class=common>character</i> <b>u+20</b>.


  <div class=dfn-scope>
  <h4>Character Sets</h4>
  <p>
    A <dfn>character-set</dfn> is a set of <i>character</i>s. 
    A <dfn>character-range</dfn> is the largest <i class=common>character-set</i> that
    includes a given least <i class=common>character</i> <var>c</var> and a greatest
    <i class=common>character</i> <var>d</var>.
    Such a <i>character-range</i> is denoted by
    <span class=-nowrap>{Â <var>c</var>â€“<var>d</var>Â }.</span> 
    The union of e.g. <span class=-nowrap>{Â <var>a</var>â€“<var>b</var>Â }</span>
    and <span class=-nowrap>{Â <var>c</var>â€“<var>d</var>Â }</span>, is denoted by
    <span class=-nowrap>{Â <var>a</var>â€“<var>b</var>,Â <var>c</var>â€“<var>d</var>Â }</span>,
    and this notation is generalised to <var>n</var>-ary unions. 
    Common <i class=common>character-set</i>s that are used throughout this document
    are defined below: 
  </div>

  <script class="grammar" type=bnf>
    any             := { u+0-u+10FFFF }
    ascii           := { u+0-u+7F }
    control-c0      := { u+0-u+1F }
    c0-space        := { u+0-u+20 }
    printable-ASCII := { u+20-u+7E }
    octal-digit     := { 0-7 }
    digit           := { 0-9 }
    hex-digit       := { 0-9,  A-F,  a-f }
    digit-nonzero   := { 1-9 }
    alpha           := { A-Z, a-z }
    del-c1          := { u+7F-u+9F }
    control-c1      := { u+80-u+9F }
    non-ASCII       := { u+80-u+10FFFF }
    surrogate       := { u+D800-u+DFFF }
    non-char        := { u+FDD0-u+FDEF } âˆª { c | c in any and (c + 2) mod 2^16 < 2 }
    other-unicode   := non-ASCII \ surrogate \ non-char
    control         := control-c0 âˆª del-c1 âˆª surrogate âˆª non-char
  </script>

  <p class=todo>
    Fix the notaton of 2<sup>16</sup> above

  <h4>Grammars</h4>
  <p>
    The notation <var>name</var>Â ::=Â <var>expression</var> is used to define
    a production rule of a grammar, where the <dfn>expression</dfn> uses
    square brackets (Â [Â â€¦Â ]Â ) <strong>for optional rules</strong>, a postfix
    star (Â *Â ) for zero-or-more, a postfix plus (Â +Â ) for one-or-more, an infix
    vertical line (Â |Â ) for alternatives, monospaced type for literal
    <i class=common>string</i>s and an epsilon (Â ÎµÂ ) for the empty string. 
    Concatenation takes the highest precedence, followed by (Â *Â ) and (Â +Â ),
    and (Â |Â ) is used with lowest operator precedence. Parentheses are used for 
    grouping and disambiguation. 


  <h4>Pattern Testing</h4>
  <p>
    The shorthand notation <var>string</var>Â ::Â <var>rule</var> is used to
    express that a <i class=common>string</i> <var>string</var> can be
    generated by the production rule <var>rule</var> of a given grammar.
    <br>Likewise, the notation 
    <var>string</var> :: <var>expression</var> is used to express that 
    <var>string</var> can be generated by <var>expression</var>.

  
  <h3>Percent Coding</h3>
  <p>
    This subsection is analogous to the section 
    <a href="https://tools.ietf.org/html/rfc3986#section-2.1">Percent-Encoding</a> of
    <abbr class=caps>RFC</abbr>Â 3986 and the section 
    <a href="https://url.spec.whatwg.org/#percent-encoded-bytes">Percent-encoded bytes</a>
    of the <abbr class=caps>WHATWG</abbr> standard.
    
  <!-- <p>
    On an abstract level, <em>percent encoding</em> is a means to include characters in
    <i class=common>component</i> <i class=common>value</i>s that can not be used within
    <i><span class=url>URL</span>-string</i>s directly. -->


  <h4>Bytes</h4>
  <p>
    For the purpose of this specification,
  <ul class="indent dfn-scope">
    <li>
      A <dfn>byte</dfn> is a natural number <var>n</var>Â &lt;Â 2<sup>8</sup>.
    <li>
      A <dfn>byte-sequence</dfn> is a <i>sequence</i> of <i>byte</i>s.
  </ul>


  <h4>Percent Encoded Bytes</h4>
  <p>
    A non-empty <i>byte-sequence</i> may be <dfn>percent-encoded</dfn> as
    a <i>string</i> by rendering each individual <i class=common>byte</i>
    in two-digit hexadecimal notation, prefixed byÂ <code>%</code>.
  </p>
  
  <script class="indent grammar dfn-scope" type=bnf>
    pct-encoded-byte  ::= `%` hex-digit hex-digit
    pct-encoded-bytes ::= pct-encoded-byte+
  </script>


  <h4>Percent Encoded String</h4>
  <p>
    A <dfn>percent-encodedâ€“string</dfn> is a string that may have zero or more 
    <i>percent-encoded</i>â€“<i>byte-sequence</i>s
    embedded within, as follows:
  </p>

  <script class="indent grammar" type=bnf>
    percent-encoded-string  ::= ( pct-encoded-bytes | uncoded )*
    uncoded                 ::= non-pct+
    non-pct                 := any \ { `%` }
  </script>

  <p>
    The grammar above may be relaxed in situations where error recovery is desired. 
    This is achieved by adding a <i>pct-invalid</i> rule as follows:
  </p>

  <script class="indent grammar" type=bnf>
    percent-encoded-string  ::= ( pct-encoded-bytes  |  pct-invalid  |  uncoded )*
    pct-invalid             ::= `%` [ hex-digit ]
  </script>

  <p>
    There is an ambiguity in the loose grammar due to the overlap between <i>pct-encoded-bytes</i>
    and <i>pct-invalid</i> combined with <i>uncoded</i>. The ambiguity must be resolved by using
    the <i>pct-encoded-bytes</i> rule instead of the <i>pct-invalid</i> rule wherever possible.


  <h4>Percent Encoding</h4>
  <p>
    To <i>percent-encode</i> a <i class=common>string</i> <var>string</var> using a given
    <i class=common>character-set</i> <var>encode-set</var>
    â€¦

  <!-- <h4>Percent Encode Set</h4>
    <p>
      A <dfn>percent-encode-set</dfn> is a subset of the
      <i class=common>printable-<abbr class=caps>ASCII</abbr></i> characters
      that is used as a configuration argument to a
      <i>percent-encode</i> operation on <i>string</i>s.us

  <p class=note>
    This restricts the encode sets to printable ASCII. 
    Non-url code points must also be encoded, but it makes sense to mandate that
    and not make it configurable via the encode set, but this is work in progress. 
    <br>-->

  <p class=todo>
    The only tricky bit in this is is the encoding of multi-byte UTF8 sequences, and the optional
    encoding override to specify a non-UTF8 encoding for the query component.

  <h4>Percent Decoding</h4>
  <p class=-br>
    Percent decoding of strings is stratified into the following phases:

  <ul>
    <li>
      Analyse the string into <i>pct-encoded-bytes</i>, <i>pct-invalid</i> and <i>uncoded</i>
      parts according to the <i>pct-encoded-string</i> grammar.
    <li>
      Convert each of the the <i>pct-encoded-bytes</i> parts to a <i>byte-sequence</i> and decode
      the byte sequence to a <i>string</i> assuming that <i>byte-sequence</i> uses the
      <a href="https://www.unicode.org/versions/latest/">Unicode</a>
      UTF-8 encoding. Leave the <i>pct-invalid</i> and <i>uncoded</i> parts unmodified.<br>
      <!-- TODO handling invalid UTF8 -->
    <li>
      Recompose the string by concatenating each of the parts
  </ul>

</section>


<!----------------------------->


<section>

  <h2 id=url-model>URL Model</h2>

  <p>
    An <span class=url>URL</span>, or specifically an <i class=url>URL</i>-<em>structure</em>, is
    conceptually distinct from an <span class=url>URL</span>-<em>string</em>.

    An <i class=common><span class=url>URL</span></i>-<em>structure</em> is a collection of
    components that adheres to a number of constraints, whereas an <span class=url>URL</span>-<em>string</em>
    is a <em>string</em> that <em>represents</em> an <span class=url>URL</span>. 

    An <span class=url>URL</span>-<em>string</em> has an internal structure that can be parsed as
    an <span class=url>URL</span>-<em>structure</em>.
    Conversely, an <span class=url>URL</span>-<em>structure</em> may be converted to an
    <span class=url>URL</span>-<em>string</em>.

  <div class="dfn-scope +br">
    <h4>URL</h4>
    <p>
      An <dfn class=url>URL</dfn> is a <i>sequence</i> of
      <i>component</i>s. The components are ordered by their type
      in an ascending order where the types are taken from the ordered set: 

    <p class=center>
      <b>scheme</b> Â &lt;Â  <b>authority</b> Â &lt; <b>drive</b>
      Â &lt;Â  <b>path-root</b> Â &lt;Â  <b>dir</b> Â &lt;Â  <b>file</b>
      Â &lt;Â  <b>query</b> Â &lt;Â  <b>fragment</b>.

    <p>
      An <i class=url>URL</i> must contain <strong>at most</strong> one <i class=common>component</i>
      of each <i class=common>type</i> except for <b>dir</b> <i class=common>component</i>s,
      of which it may have any finite amount. 
      <span class=dfn-scope>It must uphold the <dfn>path-root-constraint</dfn>: 
      If an <i class=url>URL</i> has an
      <b>authority</b> or a <b>drive</b> <i class=common>component</i>,
      and it also has a <b>dir</b> or a <b>file</b> component, then it must also have a <b>path-root</b>
      <i class=common>component</i>.</span>
      If present, then the <i>value</i> of each of
       the <i class=common>component</i>s have the following structure:

    <p class=indent>
      The <b>scheme</b> is a <i class=common>string</i>
      <span class=rule><var>scheme</var> :: <i>alpha</i> (<i>alpha</i> | <i>digit</i> |
        <code>+</code> | <code>-</code> | <code>.</code>)*</span>.
      <br>
        The <b>authority</b> component is a <i>compound-component</i> and its value is an
        <i>Authority</i>.
      <br>
        The <b>drive</b> is a two-character <i class=common>string</i>
        <nowrap><var>drive</var> :: <i>alpha</i> (<code>:</code> | <code>|</code>)</nowrap>.
      <br>
        The <b>path-root</b> is the single character string <code>/</code>.
      <br>
        The <b>dir</b>, <b>file</b>, <b>query</b> and <b>fragment</b> are <i>percent-encoded-string</i>s.
      <br>
         However, the <b>file</b> must be a <em>nonempty</em> <i class=common>percent-encoded-string</i>, if present.
  </div>
  
  <p>
    In an <span class=url>URL</span>-<i class=common>string</i> the component values are delineated
    from each other by means of <dfn>sigil</dfn>s. Most component-types have an associated
    sigil that is used either in a prefixâ€“ or postfix position to its value.
    However, in the case of the <b>path-root</b> the sigil is the single <code>/</code> 
    character itself, and the <b>file</b>, <b>host</b> and <b>username</b> components do not
    have an associated sigil at all.

    The components of an <span class=url>URL</span> are paired with sigils as follows:

    <table class=indent>
    <tr>
      <td><b>scheme</b> <var>scheme</var><td> Â âŸ¼Â  <td><var>scheme</var> <code>:</code>
    <tr>
      <td><b>authority</b> <var>auth</var> <td> Â âŸ¼Â  <td><code>//</code> <var>auth</var>
    <tr>
      <td><b>drive</b> <var>x</var> <td> Â âŸ¼Â  <td><code>/</code> <var>x</var>
    <tr>
      <td><b>path-root</b> <var>s</var> <td> Â âŸ¼Â  <td><code>/</code>
    <tr>
      <td><b>dir</b> <var>name</var> <td> Â âŸ¼Â  <td><var>name</var> <code>/</code>
    <tr>
      <td><b>file</b> <var>name</var> <td> Â âŸ¼Â  <td><var>name</var>
    <tr>
      <td><b>query</b> <var>query</var> <td> Â âŸ¼Â  <td><code>?</code> <var>query</var>
    <tr>
      <td><b>fragment</b> <var>frag</var> <td> Â âŸ¼Â  <td><code>#</code> <var>frag</var>
  </table>

  <!-- <p>
    The pairing of the components with sigils is very carefully chosen
    mirror the constraints on an <i class=url>URL</i>, on its
    <i>Authority</i> and its <i>Userinfo</i>. -->

  <p>
    Note that the second character <code>:</code> or <code>|</code>
    of a <b>drive</b> component value is not considered to be its sigil,
    but is instead a part of its value.


  <script class="grammar url-grammar" type=bnf>
    url              ::= [ scheme `:` ] ( auth-path | path ) [ `?` query ] [ `#` fragment ]
  </script>

  <h3>Types and Shapes</h3>

  <p>
    There is a further categorisation of <i class=url>URL</i>s that is used in 
    several of the operations that will be defined later. 

  <div class="dfn-scope +br">
  <h4>Web-URL</h4>
    <p class=-br>
      A <dfn>web-<span class=url>URL</span></dfn> is an
      <i class=url>URL</i> that has a <i>web-<b>scheme</b></i>.
      <!-- A <dfn>non-special <span class=url>URL</span></dfn> is an
      <span class=url>URL</span> that is not <i>special</i>. -->
      A <dfn>web-<b>scheme</b></dfn> is a <i class=common>string</i>
      <var>scheme</var> such that
      (lowercaseÂ <var>scheme</var>)Â :: <span class=rule>
        <code>http</code> | <code>https</code> | <code>ws</code> |
        <code>wss</code> | <code>ftp</code></span>.
  </div>

  <div class="dfn-scope +br">
  <h4>File-URL</h4>
    <p>
      A <dfn>file-<span class=url>URL</span></dfn> is an
      <i class=url>URL</i> that has a <i>file-<b>scheme</b></i>.
      A <dfn>file-<b>scheme</b></dfn> is a <i class=common>string</i>
      <var>scheme</var> such that
      <span class=rule>(lowercaseÂ <var>scheme</var>)Â :: <code>file</code></span>. 
  </div>

  <div class="dfn-scope +br">
  <h4>Schemeless-URL</h4>
    <p>
      A <dfn>schemeless-<span class=url>URL</span></dfn> is an
      <i class=url>URL</i> that does not have a <b>scheme</b> <i class=common>component</i>.
  </div>
</section>


<!----------------------------->


<section>

  <h2 id=authority-model>Authority Model</h2>

  <p>
    The <b>authority</b> component of an <i class=url>URL</i> is a <i>compound-component</i>
    and its value is an <i>Authority</i> structure:
  
  <div class="dfn-scope +br">
    <h4>Authority</h4>

    <p>
      An <dfn>Authority</dfn><dfn class=hidden>authority</dfn>
      is a sequence of components ordered by their type, taken from the ordered set:

    <p class=indent>
      <b>userinfo</b> Â &lt;Â  <b>host</b> Â &lt;Â  <b>port</b>.

    <p>
      An Authoritiy must have <strong>at most</strong> one <i class=common>component</i>
      per <i class=common>type</i>, but if it does have a <b>userinfo</b> or a
      <b>port</b> <i class=common>component</i> then it must also have a <b>host</b>
      <i class=common>component</i>. If present, the <i>value</i> of the
      <i class=common>components</i> have the following structure:
    
    <p class=indent>
      The <b>userinfo</b> is a <i>Userinfo</i> structure.
    <br>
      The <b>password</b> is a <i>percent-encoded-string</i>.
    <br>
      The <b>host</b> is a <i>Host</i> structure.
    <br>
      The <b>port</b> is a natural number <var>n</var> Â &lt;Â  2<sup>16</sup>
      or the empty string <i>Îµ</i>.
  </div>

  <p>
   In an <span class=url>URL</span>-string, 
   the components of an <i>Authority</i> are paired with sigils as follows:
    
  <table class=indent>
    <tr>
      <td><b>userinfo</b> <var>info</var>
      <td> Â âŸ¼Â 
      <td><var>info</var> <code>@</code>
    <tr>
      <td><b>host</b> <var>value</var>
      <td> Â âŸ¼Â  
      <td><var>value</var>
    <tr>
      <td><b>port</b> <var>Îµ</var>
      <td> Â âŸ¼Â  
      <td><code>:</code>
    <tr>
      <td><b>port</b> <var>n</var>
      <td> Â âŸ¼Â  
      <td><code>:</code> <var>n</var>
  </table>

  <div class="dfn-scope +br">
    <h4>Userinfo</h4>
    <p>
      <dfn class=hidden>userinfo</dfn>
      The <dfn>Userinfo</dfn> is a sequence of components ordered by their type,
      taken from the ordered set:

    <p class=indent>
      <b>username</b> &lt; <b>password</b>.

    <p>
      The <i>Userinfo</i> must have a single <b>username</b> component, and at most one
      <b>password</b> component.
  </div>

  <p>
    Finally, the components of the <i>Userinfo</i>
    are paired with sigils as follows:

  <table class=indent>
    <tr>
      <td><b>username</b> <var>name</var>
      <td> Â âŸ¼Â  
      <td><var>name</var>
    <tr>
      <td><b>password</b> <var>pass</var>
      <td> Â âŸ¼Â  
      <td><code>:</code> <var>pass</var>
  </table>

  <div class="dfn-scope +br">
    <h4>Host</h4>
    <p>
      A <dfn>Host</dfn> is either:
    <div><ul class=-inline>
      <li>
        An ipv6-address,
      <li>
        an opaque-host,
      <li>
        an ipv4-address, or
      <li>
        a domain-name.
    </ul></div>
  </div>

  <p>
    The <abbr class=caps>WHATWG</abbr> standard specifies scheme-dependent expectations
    on the <i>Host</i> of an <i class=url>URL</i>.
    For any generic <i class=url>URL</i> it merely enforces that its <i>opaque-host</i>
    does not contain certain characters, as is specified by the
    <span class=url>URL</span>-grammar. 
    However, for <b>file</b> and <b>web</b>-<i class=url>URL</i>s it attempts to parse
    their <i>opaque-host</i> as a domain or ipv4-address.
    This additional <i>Host</i> parsing is stratified into the following phases:

  <ul>
    <li>
      Percent decode.
    <li>
      Apply domain-to-<abbr class=caps>ASCII</abbr>
    <li>
      Err on 'forbidden domain codepoints'.
    <li>
      Detect and interpret IPv4 addresses.
  </ul>


  <h3>IPv6 Address</h4>

  <h4><abbr class=caps>IP</abbr>v6 Address â€” Strict</h4>
  <p>
    An <abbr class=caps>IP</abbr>v6 address-string is a representation
    of a natural number <var>n</var>Â &lt;Â 2<sup>128</sup> that is used as an identifier. 
    It is accurately described by the production rule <var>IPv6address</var>
    in the <a href=https://tools.ietf.org/html/rfc3986#section-3.2.2>Host
    section</a> of <abbr class=caps>RFC</abbr>Â 3986. 

  <p>
    The <a href=https://url.spec.whatwg.org/#concept-ipv6-parser><abbr class=caps>IP</abbr>v6 address parser</a>
    in the <abbr class=caps>WHATWG</abbr> standard however implies a more tolerant definition
    of <abbr class=caps>IP</abbr>v6 address-strings. 

  <h4>IPv6 Address â€” Loose</h4>
  <div class=todo>
  </div>


  
  <h3>Domain and IPv4 Address</h3>

  <section>
  <h4>IPv4 Address</h4>
  <p>
    An IPv4 address-string consists of one up to four dot-separated numbers with
    an optional trailing dot. The numbers may use decimal, octal or hexadecimal
    notation, as follows:
  </p>

  <script class="indent grammar" type=bnf>
    ip4-address ::= num [`.` num [`.` num [`.` num ] ] ] [`.`]
    num         ::= num-dec | num-oct | num-hex
    num-dec     ::= `0` | (digit-nonzero digit*)
    num-oct     ::= `0` octal-digit+
    num-hex     ::= (`0x` | `0X`) hex-digit*
  </script>

  <p>
    Note that <code>0x</code> is parsed as a hexadecimal number;
    it is interpreted as 0.

  <p class=todo>
    There is an additional semantic constraint that can render invalid an ipv4-address that uses
    the loose grammar; specifically, it must not represent a number that exceeds the addressable
    range of 2<sup>32</sup>; Where the amount of segments determines the magnitude of the segment. â€¦

  <h4>IPv4 Address â€“ Strict</h4>
  <p>
    A <em>strict</em> IPv4 address-string consists of four dot-separated numbers, <em>without</em> a
    trailing dot, where in addition each number must use the shortest possible decimal
    representation of a natural number <var>n</var> â‰¤ 255.

  <div class=indent>
    <script class="grammar" type=bnf>
      ip4-address-strict ::= num-dec `.` num-dec `.` num-dec `.` num-dec
    </script>

    <p class="inbetween">
      The use of the shortest decimal representation can be expressed as follows:
    </p>
  
    <script class="grammar" type=bnf>
      ip4-address-strict ::= dec-octet `.` dec-octet `.` dec-octet `.` dec-octet
      dec-octet ::= digit | digit-nonzero digit | `1` digit digit
                  | `2` pental-digit digit
                  | `2` `5` senary-digit
      -- Where pental-digit and senary-digit are defined as follows:
      pental-digit := { 0-4 }
      senary-digit := { 0-5 }
    </script>
  </div>
  </section>

</section>


<!----------------------------------->


<section>
  
  <h2 id=component-characters>Component Characters</h2>


  <!-- <p>
    There is an additional number of soft constraints that must be met for
    an <i class=url>URL</i> in order to be called <i>valid</i>.

  <div class="dfn-scope +br">
  <h4>Valid URL</h4>
    <p>
      A <dfn>valid</dfn> <i class=url>URL</i> must not have a <b>username</b> or a
      <b>password</b> component and it must not have <i class=common>component</i>s
      that contain invalid percent-encode sequences.
  </div> -->

    <p>
      When it comes to handling characters that may occur in <span class=url>URL</span>-component
      values we have &lsquo;for historical reasons&rsquo; ended up in
      a situation where we distinguish <em>per</em> component, characters that are:
    <ul>
      <li>
        <dfn class=op>v</dfn>:Â 
        valid;
      <li>
        <dfn class=op>E</dfn>:Â 
        valid but percent-encoded;
      <li>
        <dfn class=op>T</dfn>:Â 
        invalid but tolerated;
      <li>
        <dfn class=op>F</dfn>:Â 
        invalid and fixed by percent-encoding;
      <li>
        <dfn class="op R">R</dfn>:Â 
        invalid and rejected.
    </ul>

  <p>
    In order to specify the how characters must be handled in components, it us useful to first
    divide the entire space of characters <i>any</i> into <strong>non-overlapping</strong>
    character sets as follows:
  </p>

  <script class="indent grammar" type=bnf>
  unreserved    :=  { `-`, `.`, `_`, `~` } âˆª alpha âˆª digit âˆª other-unicode
  sub-delims    :=  { `!`, `$`, `&`, `'`, `(`, `)`, `*`, `+`, `,`, `;`, `=` }
  gen-delims    :=  { `:`, `@`, `/`, `?`, `#` }
  invalid       :=  { ` `, `"`, '`', `<`, `>`, `[`, `]`, `{`, `}`, `\`, `^`, `|` } âˆª control
  pct           :=  { `%` }
  </script>

  <p>
    This collection of character sets covers the entire character space.
    To exhaustively specify how characters in components should be handled we divide each of these sets
    into further subdivisions and specify per component the status of the characters in this subset:

  <table id=characters class=indent>
    <thead>
      <tr><th><th>
      <th><span><b>username</b></span>
      <th><span><b>password</b></span>
      <th><span><i class=common>opaque-host</i></span>
      <th><span><b>dir</b> and <b> file</b></span>
      <th><span>opaque path</td></span>
      <th><span><b>query</b></span>
      <th><span style=border:none><b>fragment</b></span>
    </th>
    </thead>

    <tbody>
      <tr>
        <th rowspan=3>unreserved</th>
        <th><code>-</code> <code>.</code> <code>_</code> <code>~</code>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
      <tr>
        <th><i class=common>alpha âˆª digit</i>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
      <tr><th colspan=1><i class=common>other-unicode</i>
        <td><b>E</b>
        <td><b>E</b>
        <td><b>E</b>
        <td><b>E</b>
        <td><b>E</b>
        <td><b>E</b>
        <td><b>E</b>

      <tr>
        <th rowspan=3>sub-delims</th>
        <th><code>!</code> <code>$</code> <code>&</code>
          <code>(</code> <code>)</code>
          <code>*</code> <code>+</code> <code>,</code>

        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
      <tr>
        <th><code>'</code>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b>E</b><sup>1</sup>
        <td><b class=op>v</b>
      <tr>
        <th><code>;</code> <code>=</code>
        <td><b>E</b>
        <td><b>E</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>

      <tr>
        <th rowspan=5><i class=common>gen-delims</i>
        <th><code>@</code>
        <td><b>F</b>
        <td><b>F</b>
        <td><b class=R>R</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>

      <tr>
        <th><code>:</code>
        <td><b class=na>n/a</b>
        <td><b>F</b>
        <td><b class=na>n/a</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
      <tr>
        <th><code>/</code>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><i class=op>T</i>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
      <tr><th><code>?</code>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=op>v</b>
        <td><b class=op>v</b>
      <tr><th><code>#</code>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><i class=op>T</i>
      </tr>
      <tr>
        <th rowspan=1><i class=common>pct</i>
        <th><code>%</code></th>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
      <tr>
        <th rowspan=9><i class=common>invalid</i>
        <th><b>u+9</b>,Â <b>u+A</b>,Â <b>u+D</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
        <td><b class=na>n/a</b>
      <tr>
        <th><b>u+0</b>
        <td><b>F</b>
        <td><b>F</b>
        <td><b class=R>R</b>
        <td><b>F</b>
        <td><b>F</b>
        <td><b>F</b>
        <td><b>F</b>
      <tr><th>other <i class=common>control</i>
        <td><b>F</b>
        <td><b>F</b>
        <td><b>F</b>
        <td><b>F</b>
        <td><b>F</b>
        <td><b>F</b>
        <td><b>F</b>
      <tr>
        <th><code><span style=display:inline-block;width:1ch> </span></code>
        <td><b>F</b>
        <td><b>F</b>
        <td><b class=R>R</b>
        <td><b>F</b>
        <td><i class=op>T</i>
        <td><b>F</b>
        <td><b>F</b>
      <tr>
        <th><code>"</code>
        <td><b>F</b>
        <td><b>F</b>
        <td><i class=op>T</i>
        <td><b>F</b>
        <td><i class=op>T</i>
        <td><b>F</b>
        <td><b>F</b>
      <tr>
        <th><code>&lt;</code> <code>></code>
        <td><b>F</b>
        <td><b>F</b>
        <td><b class=R>R</b>
        <td><b>F</b>
        <td><i class=op>T</i>
        <td><b>F</b>
        <td><b>F</b>
      <tr>
        <th><code>`</code>
        <td><b>F</b>
        <td><b>F</b>
        <td><i class=op>T</i>
        <td><b>F</b>
        <td><i class=op>T</i>
        <td><i class=op>T</i>
        <td><b>F</b>
      <tr>
        <th><code>[</code> <code>\</code> <code>]</code> <code>|</code> <code>^</code>
        <td><b>F</b>
        <td><b>F</b>
        <td><b class=R>R</b>
        <td><i class=op>T</i>
        <td><i class=op>T</i>
        <td><i class=op>T</i>
        <td><i class=op>T</i>
      <tr>
        <th><code>{</code> <code>}</code>
        <td><b>F</b>
        <td><b>F</b>
        <td><i class=op>T</i>
        <td><b>F</b>
        <td><i class=op>T</i>
        <td><i class=op>T</i>
        <td><i class=op>T</i>

    </tbody>
    <tfoot>
      <tr><th><th>
      <th><span><b>username</b></span>
      <th><span><b>password</b></span>
      <th><span><i class=common>opaque-host</i></span>
      <th><span><b>dir</b> and <b> file</b></span>
      <th><span>opaque path</td></span>
      <th><span><b>query</b></span>
      <th><span><b>fragment</b></span>
    </th>
    </tfoot>
  </table></div>
  </div>

  <p class=note>
    Note that applying the rules for encoding component characters does <strong>not</strong>
    necessarily produce valid URLs, specifically, if a component contains a character that is 
    marked as <b>T</b>: invalid but tolerated.

  <p class=todo>
    Note that the apostrophe ' must instead be left untouched in the <b>query</b> of non-special urls;
    and the path of generic urls that have no auth nor root are handled as per the opaque path column.

</section>


<!----------------------------------->


<section>
  
  <h2 id=reference-resolution>Reference Resolution</h2>

  <p>
    This section defines reference resolution operations that are analogous to the
    algorithms that are described in the chapter
    <a href="https://tools.ietf.org/html/rfc3986#section-5">Reference Resolution</a> of
    <abbr class=caps>RFC</abbr>Â 3986. The operations that are defined in this section are
    used in a subsequent section to define a <em>parse-resolve-and-normalise</em>
    operation that accurately describes the behaviour of the
    &lsquo;<a href="https://url.spec.whatwg.org/#concept-basic-url-parser">basic
    <span class=url>URL</span> parser</a>&rsquo; as defined in the 
    <abbr class=caps>WHATWG URL</abbr> standard.

  <p>
    Reference resolution as defined in this section does not involve
    <i><span class=url>URL</span>-string</i>s. It operates on <i class=url>URL</i>s as
    defined in the <a href=#url-model><span class=url>URL</span> Model</a> section above.
    In contrast with <abbr class=caps>RFC</abbr>Â 3986 and with the
    <abbr class=caps>WHATWG</abbr> standard, it does <strong>not</strong> do additional
    normalisation, which is relegated to the section
    <a href=#equivalences-and-normalisation>Equivalences and Normalisation</a> instead.


  <h3>Order and Prefix</h3>

  <p>
    A property that is particularly useful is the <i>order</i> of an <i class=url>URL</i>.
    Colloquially, the <i class=common>order</i> is the
    <i class=common>type</i> of the first <i class=common>component</i>
    of an <i class=url>URL</i>. The <i class=common>order</i>
    may be used as an argument to specify various prefixes of an
    <i class=url>URL</i>.

  <div class="dfn-scope +br">
    <h4>The Order of an <span class=url>URL</span></h4>
    <p class=-br>
      The <dfn>order</dfn> of an <i class=url>URL</i> (<dfn class=fn>ord</dfn>
      <var>url</var>) is
      defined to be:
    <ul>
      <li>
        <b>fragment</b> if <var>url</var> is the empty <i class=url>URL</i>.
      <li>
        The <i class=common>type</i> of its first <i class=common>component</i>
        otherwise.
    </ul>

    <h4>Order Prefix</h4>
    <p class=-br>
      The <dfn>order-prefix</dfn>
      (<var>url</var> <dfn class=op>upto</dfn> <var>order</var>)
      is defined to be <br>
      the <em>shortest</em> prefix of <var>url</var> that contains:
      <ul>
        <li>
          all <i class=common>component</i>s of <em>url</em> with a
          <i class=common>type</i> strictly
          smaller than <var>order</var> and
        <li>
          all <b>dir</b> <i class=common>component</i>s with a
          <i class=common>type</i> weakly smaller
          than <var>order</var>.
    </ul>
  </div>


  <h3>Reference Transformation</h3>

  <p>
    Based on the <i class=common>order</i> and the <i class=common>order-prefix</i> we define
    a &ldquo;<i class=common>rebase</i>&rdquo; operation that slightly generalises reference
    transformation as specified in the section
    <a href="https://tools.ietf.org/html/rfc3986#section-5.2.2">Transform References</a>
    of <abbr class=caps>RFC</abbr>Â 3986.

  <div class="dfn-scope">
    <h4>Rebase</h4>
    <p>
      The <dfn>rebase</dfn> operation
      <span class=-nowrap>(<var>url</var> <dfn class=op>onto</dfn> <var>base-url</var>)</span>
       is defined to return <br>
      the <em>shortest</em> <i class=url>URL</i> that has <var>base-url</var> <b class=fn>upto</b>
      (<b class=fn>ord</b> <var>url</var>) as a prefix and <var>url</var> as a postfix.
  </div>

  <p>
    Be aware that <i>rebase</i> does a bit more than simple sequence concatenation.
    It may add a <b>path-root</b> component to satisfy the
    <i>path-root-constraint</i> of the <i class=url>URL</i> model. 
    For example, if <var>base</var> is the <i class=url>URL</i> represented by <code>//host</code>
    and <var>input</var> is the <i class=url>URL</i> represented by <code>foo/bar</code>
    then (<var>input</var> <i class=op>onto</i> <var>base</var>)
    is represented by <code>//host/foo/bar</code>, thus containing a <b>path-root</b> even
    though neither <var>base</var> nor <var>input</var> has one.

  <h4>Rebase Properties</h4>
  <p class=-br>
    The <i>rebase</i> operation has a number of pleasing mathematical
    properties, as follows:
  <ul>
    <li>
      <i class=op>ord</i> (<var>url<sub>2</var> <i class=op>onto</i> <var>url<sub>1</sub></var>)
        Â is the least type ofÂ  { <i class=op>ord</i> <var>url<sub>1</sub></var>, 
          <i class=op>ord</i> <var>url<sub>2</sub></var> }
    <li>
      (<var>url<sub>3</sub></var> <i class=op>onto</i>
       <var>url<sub>2</sub></var>) <i class=op>onto</i>
       <var>url<sub>1</sub></var> Â =Â 
       <var>url<sub>3</sub></var> <i class=op>onto</i>
      (<var>url<sub>2</sub></var> <i class=op>onto</i>
       <var>url<sub>1</sub></var>)
    <li>
      <var>url<sub>1</sub></var> <i class=op>onto</i> Îµ Â =Â 
      <var>url<sub>1</sub></var>
    <li>
      Îµ <i class=op>onto</i> <var>url<sub>1</sub></var> Â =Â 
      <var>url<sub>1</sub></var>
      Â â€”Â if <var>url<sub>1</sub></var> does not have a <b>fragment</b>.
  </ul>

  <h3>Forcing</h3>
  <p>
    Forcing is used as a final step in the process of resolving a
    <i>web-<span class=url>URL</span></i> or a <i>file-<span class=url>URL</span></i>. 
    It ensures that the forced <span class=url>URL</span> has an <b>authority</b>
    component and a <b>path-root</b> component. Note that it is possible for the force operations to
    <strong>fail</strong>.
  </p>

  <div class="dfn-scope +br">
  <h4>Forcing a File URL</h4>
    <p class=-br>
      To <dfn>force</dfn> a <i>file-<span class=url>URL</span></i> <var>url</var>:
      <ul>
        <li>
          If <var>url</var> does <strong>not</strong> have an <b>authority</b> then set its
          <b>authority</b> component to (<b>authority</b>Â Îµ).
        <li>
          If otherwise the <b>authority</b> of <var>url</var> has a
          <b>username</b> or a <b>port</b> then <strong>fail</strong>.
        <li>
          If <var>url</var> does not have a <b>drive</b> then set its 
          <b>path-root</b> component to (<b>path-root</b>Â <code>/</code>).
      </ul>
  </div>

  <div class="dfn-scope +br">
    <h4>Forcing a Web URL</h4>
    <p class=-br>
      To <dfn>force</dfn> a <i>web-<span class=url>URL</span></i>
      <var>url</var>:
    <ul>
      <li>
        Set the <b>path-root</b> component of <var>url</var> to
        (<b>path-root</b>Â <code>/</code>).
      <li>
        If <var>url</var> has a non-empty <b>authority</b> then return.
      <li>
        Otherwise let <var>component</var> be the first <b>dir</b> or
        <b>file</b> <i class=common>component</i> whose value is not Îµ.
        <br>If no such <i class=common>component</i> exists, <strong>fail</strong>.
      <li> 
        Remove all <b>dir</b> or <b>file</b> <i class=common>component</i>s that
        precede <var>component</var> and remove <var>component</var> as well. 
      <li>
        Let <var>auth</var> be the <i>value</i> of <var>component</var> parsed as
        an <i>Authority</i> and set the <b>authority</b> of <var>url</var> to
        <var>auth</var>. If the value cannot be parsed as an <i>Authority</i>
        then <strong>fail</strong>.
    </ul>
  </div>

  <h4>Force Properties</h4>
  <p>
    The <i>force</i> operation does not have pleasing mathematical properties with respect to the
    <i>rebase</i> operation. The following equalities do not hold in general: 
  <table class="indent grammar">
    <tr>
      <td><i class=op>force</i> ((<i class=op>force</i> <var>url<sub>1</sub></var>)  
      <i class=op>onto</i>
      (<i class=op>force</i> <var>url<sub>2</sub></var>))
      <td> â‰  
      <td><i class=op>force</i> (<var>url<sub>1</sub></var>  
      <i class=op>onto</i>
      <var>url<sub>2</sub></var>)
    <tr>
      <td><i class=op>force</i> ((<i class=op>force</i> <var>url<sub>1</sub></var>)  
      <i class=op>onto</i>
      <var>url<sub>2</sub></var>)
      <td> â‰  
      <td><i class=op>force</i> (<var>url<sub>1</sub></var>  
      <i class=op>onto</i>
      <var>url<sub>2</sub></var>)
    <tr>
      <td><i class=op>force</i> (<var>url<sub>1</sub></var>  
      <i class=op>onto</i>
      (<i class=op>force</i> <var>url<sub>2</sub></var>))
      <td> â‰  
      <td><i class=op>force</i> (<var>url<sub>1</sub></var>  
      <i class=op>onto</i>
      <var>url<sub>2</sub></var>)
  </table>


  <h3>Resolution</h3>

  <p>
    The subsection
    <a href="https://datatracker.ietf.org/doc/html/rfc3986#section-5.2.2"
    >Transform References</a> of <abbr class=caps>RFC</abbr>Â 3986 specifies <em>two</em>
    variants of reference resolution. A generic, <em>strict</em> variant and an
    alternative <em>non-strict</em> variant. 
    I have chosen to rename the <em>non-strict</em> variant to <i>legacy resolution</i>. 

    This specification adds a third variant that characterises 
    the behaviour that is specified in the <abbr class=caps>WHATWG</abbr> standard. 

  <!--<p>
    As an example, consider resolving the <abbr class=-url>URL</abbr> represented by 
    <code>scheme:foo/bar</code> against the <abbr class=-url>URL</abbr> represented by 
    <code>scheme://host/</code>. If <i>legacy resolution</i> is used, then the
    <b>scheme</b> of the reference is ignored and the resolution results in 
    <code>scheme://host/foo/bar</code>. However, <i>generic resolution</i> results in
    <code>scheme:foo/bar</code> â€” notice that the result does nnot have an authority. -->

  <div class="dfn-scope +br" id="resolution">
    
    <div style=display:none>
      <dfn>resolution</dfn>
      <dfn>resolve</dfn>
      <dfn>strict-resolution</dfn>
      <dfn>legacy-resolution</dfn>
    </div>

    <h4>Strict Resolution</h4>
    <p>
      The <dfn>strict-resolution</dfn>
      <span class=-nowrap>(<dfn class=op>strict-resolve</dfn> <var>url</var>
      <var>base</var>)</span> of an <span class=url>URL</span> <var>url</var>
      onto an <span class=url>URL</span> <var>base</var> is defined to be
      <var>url</var>Â <i class=op>onto</i>Â <var>base</var>
      â€” if <var>url</var> has a <b>scheme</b> or <var>base</var>
      has a <b>scheme</b>. Otherwise resolution <strong>fails</strong>.

    <h4>Legacy Resolution</h4>
    <p class=-br>
      The <dfn>legacy-resolution</dfn>
      <span class=-nowrap>(<dfn class=op>legacy-resolve</dfn> <var>url</var>
       <var>base</var>)</span> is defined to be the
       <i class=common>strict-resolution</i>
      (<b class=op>strict-resolve</b> <var>~url</var> <var>base</var>)
      where <var>~url</var> is:

    <ul>
      <li>
        <var>url</var> with its <b>scheme</b> removed if both
          <var>url</var> and <var>base</var> have a <b>scheme</b>
          and the <i class=common>value</i> of their <b>scheme</b>
          <i class=common>component</i>s case-insensitively compare equal, or
      <li>
        <var>url</var> itself otherwise.
    </ul>
  </div> <!-- Resolution -->

  <div class="dfn-scope +br" id="whatwg-resolution">
    <div style=display:none>
      <dfn>WHATWG-resolve</dfn>
      <dfn>WHATWG-resolution</dfn>
    </div>

    <h4>WHATWG Resolution</h4>

    <p class=-br>
      The <dfn>whatwg-resolution</dfn> of
      <var>url</var> onto <var>base</var> is defined to be:

    <ul>
      <li>
        <i class=op>force</i> (<i class=op>legacy-resolve</i>
          <var>url</var> <var>base</var>)
        <ul>
          <li>
            if <var>url</var> is a <i>web-<span class=url>URL</span></i> or a
            <i>file-<span class=url>URL</span></i>, or
          <li>
            if <var>url</var> does not have a <b>scheme</b> and
            <var>base</var> is a <i>web-<span class=url>URL</span></i> or a
            <i>file-<span class=url>URL</span></i>;
        </ul>

      <li>
        <i class=op>strict-resolve</i>
          <var>url</var> <var>base</var>
        <ul>
          <li>
            if otherwise the first component of <var>url</var> is 
            a <b>scheme</b> or a <b>fragment</b>, or
          <li>
            if <var>base</var> has an <b>authority</b> or a <b>path-root</b>;
        </ul>
      <li>
        otherwise, the operation <strong>fails</strong>.
    </ul>

    <p>
      If <i>force</i> modifies its input then &ldquo;applications are encouraged&rdquo; to
      issue a validation warning. If in the process of <i>whatwg-resolution</i>
      either the <i>force</i> operation, or the internally used <i>strict-resolution</i>
      operation <strong>fails</strong>, then the
      <i>whatwg-resolution</i> <strong>fails</strong> as well.
  </div> <!-- WHATWG Resolution -->

</section>


<!------------------------>
<section><h2 id=parsing>Parsing</h2>
<!------------------------>
  <!--<ul>
    <li>
      An URL-string is a string that represents an URL.
    <li>
      There are strings that are not URL strings.
    <li>
      It is possible for a single URL to be represented by more than one URL
      string.
    <li>
      URL strings are further divided into valid URL strings and invalid URL
      strings.
  </ul>-->

  <p>
    Parsing is the process of converting an
    <i><span class=url>URL</span>-string</i> to an
    <i><span class=url>URL</span></i>. 
    <br>
    Parsing is stratified into the following phases:

  <ol>
    <li> Preprocessing.
    <li> Selecting a parser mode.
    <li> Parsing.
    <li> Decoding and parsing the host.
  </ol>

  <h3>Preprocessing</h3>
  <p>
    The appendix
    <a href=https://datatracker.ietf.org/doc/html/rfc3986#appendix-C>Delimiting a
    <abbr class=caps>URI</abbr> in Context</a> of <abbr class=caps>RFC</abbr>Â 3986 
    states that surrounding white-space should be removed from an
    <abbr class=caps>URI</abbr> when it is extracted from its surrounding context. 
    The <abbr class=caps>WHATWG</abbr> standard makes this more explicit and specifies a
    preprocessing step that removes removes specific controlâ€“ and white-spaceâ€“characters
    from the input string before parsing.

  <div class="dfn-scope +br">
  <h4>Preprocessing</h4>
  <p class=-br>
    Before parsing, the input string <var>input</var> must be preprocessed:
  <ol>
    <li>
      Remove all leading and trailing <i>c0-space</i>
      <i class=common>character</i>s from <var>input</var>.
    <li>
      Remove all <b>u+9</b> (tab), <b>u+A</b> (line-feed) and <b>u+D</b>
      (carriage-return) <i class=common>character</i>s from <var>input</var>.
    <li>
      If the result starts with a <i>web-<b>scheme</b></i> followed by <code>:</code>
      or with a <i>file-<b>scheme</b></i> followed by <code>:</code>
      but it <strong>does not</strong> start with a <i>scheme</i> followed by <code>:</code>
      then furthermore replace all occurrences of <code>\</code> that occur <em>before</em>
      the first character that is either an <code>?</code> or an <code>#</code>, 
      or before the end of the string otherwise,
      with the <code>/</code> character.
  </ol>
  </div>
  
  <!-- <div class=dfn-section>
  <h3>Parser Mode</h3>
  <p>
    The top-level grammar rule for <span class=url>URL</span>-strings is as follows:
  </p>

  <script class="grammar" type=bnf>
    url  ::= [ scheme `:` ] ( auth-path | path ) [ `?` query ] [ `#` fragment ]
  </script>

  <p>
    However, <b>web</b>, <b>file</b> and <b>generic</b> <i class=url>URL</i>s
    use mildly different <i>auth-path</i> rules. An additional
    problem is that it is unclear which of the varying rules should be used for parsing
    scheme-less <span class=url>URL</span>-strings.
  <p>
    This is resolved by explicitly providing a fallback <i>parser-mode-for</i>
    scheme-less <span class=url>URL</span>-strings.
  </p>

  <h4>Parser Mode</h4>
    <p>
      The <dfn>parser-mode-for</dfn> an
      <span class=url>URL</span>-string <var>input</var>, given a
      fallback <i class=common>parser-mode</i> <var>supplied-mode</var> is defined to be:
    <ul class=inbetween>
      <li>
        <dfn><b>web</b></dfn> â€” if <var>input</var> starts with a
        <i>web-<b>scheme</b></i> followed by <code>:</code>
      <li>
        <dfn><b>file</b></dfn> â€” if <var>input</var> starts with a
        <i>file-<b>scheme</b></i> followed by <code>:</code>
      <li>
        <dfn><b>generic</b></dfn> â€” if otherwise <var>input</var> starts with a
        <i><b>scheme</b>-string</i> followed by <code>:</code>
      <li>
        <var>supplied-mode</var> â€” otherwise.
    </ul>
  </div> -->

  <div class=dfn-section>
  <h3>URL Grammar</h3>
  <p>
    We can now specify the full grammar for <span class=url>URL</span>-strings,
    using an alternative version for the auth-path rule for <b>file</b>-<span class=url>URL</span></i>s:
  </p>

  <!-- <script class="grammar url-grammar" type=bnf>
    url                ::= [ scheme `:` ] ( auth-path | path ) [ `?` query ] [ `#` fragment ]
    -- The auth path rule for web and generic URLs:
    auth-path          ::= s s authority [ path-root  path-rel ]
    -- The auth path rule for file URLs:
    auth-path          ::= auth-drive [ path-root  path-rel ]
    auth-drive         ::= auth-drive-invalid | [ s s authority-empty ] [ s ] drive |  s s authority [ s drive ]
    auth-drive-invalid ::= [ ss authority-empty ] drive
    -- Rules for the authority and the path:
    authority-empty    ::= Îµ
    authority          ::= Îµ  |  [ userinfo `@` ] host [ `:` port ]
    userinfo           ::= username [ `:` password ]
    host               ::= `[` ip6-address `]`  |  opaque-host
    port               ::= Îµ | digit+
    path               ::= [ path-root ]  path-rel
    path-rel           ::= ( dir s )* [ file ]
    -- Rules for the components:
    scheme           ::= alpha (alpha | digit | `+` | `-` | `.`)*
    username         ::= ( pcts | uchar )*
    password         ::= ( pcts | pchar )*
    opaque-host      ::= ( pcts | hchar )+
    drive            ::= alpha (`:` | `|`)
    path-root        ::= s
    dir              ::= ( pcts | pchar )*
    file             ::= ( pcts | pchar )+
    query            ::= ( pcts | qchar )*
    fragment         ::= ( pcts | fchar )*
    -- Where pcts is defined as follows:
    pcts             ::= percent-encoded-bytes  |  pct-invalid
    -- The rules are based on the following character-sets:
    uchar            := any \ s \ { `%`, `#`, `?`, `:` }
    hchar            := any \ s \ { `%`, `#`, `?`, `:`, `@` } \ { u+0, ` `, `<`, `>`, `[`, `\`, `]`, `^`, `|` }
    pchar            := any \ s \ { `%`, `#`, `?` }
    qchar            := any \ { `%`, `#` }
    fchar            := any \ { `%` }
    -- Where s depends on the parser-mode:
    s                := { `/` }  -- for generic URLs
    s                := { `/`, `\` }  -- otherwise
  </script> -->
  
  <table class=grammar>
    <tr>
      <td>url 
      <td> ::= 
      <td> [ scheme <code>:</code> ] ( auth-path | path )
        [ <code>?</code> query ] [ <code>#</code> fragment ]
      <tr class=inbetween>
        <td colspan=3>The general auth-path rule:

    <tr>
      <td><dfn>auth-path</dfn> 
      <td> ::= 
      <td> <code>//</code> authority [ path-root Â path-rel ]

    <tr class=inbetween>
      <td colspan=3>The auth-path rule for <b>file</b>-<span class=url>URL</span></i>s:

    <tr>
      <td><dfn>auth-path</dfn>
      <td> ::= 
      <td> auth-drive [ path-root Â path-rel ]

    <tr>
      <td><dfn>auth-drive</dfn>
      <td> ::= 
      <td> auth-drive-invalid
        Â |Â  <code>//</code> authority [ <code>/</code> drive ]
        Â |Â  <code>/</code> drive

    <tr>
      <td><dfn>auth-drive-invalid</dfn>
      <td> ::= 
      <td> [ <code>//</code> authority<sub>Îµ</sub> ] drive

    <tr>
      <td><dfn>drive</dfn>
      <td> ::= 
      <td> <i>alpha</i> (<code>:</code> | <code>|</code>)

    <!-- <tr>
      <td><dfn>authority</dfn>
      <td> ::=
      <td> Îµ Â |Â  <i>host</i> -->

    <tr class=inbetween><td colspan=3>
      <p class=note> A forced <i>file-<span class=url>URL</span></i> however
      does not have a username, password or a port, and will have a path-root.
      Moreover if it has a non-empty authority then its host will not be an
      opaque host as it will have been processed and verified to be a domain.

    <tr class=inbetween>
      <td colspan=3>Rules for the authority and the path:

    <tr>
      <td><dfn>authority<sub>Îµ</sub></dfn> 
      <td> ::= <td> Îµ

    <tr>
      <td><dfn>authority</dfn> 
      <td> ::= 
      <td> Îµ Â |Â  [ <i>userinfo</i> <code>@</code> ] <i>host</i> [ <code>:</code> port ]

    <tr>
      <td><dfn>userinfo</dfn>
      <td> ::= 
      <td><i>username</i> [ <code>:</code> <i>password</i> ]

    <tr>
      <td><dfn>host</dfn> 
      <td> ::= 
      <td> <code>[</code> <i>ip6-address</i> <code>]</code> Â |Â  <i>opaque-host</i>

    <tr>
      <td><dfn>port</dfn> 
      <td> ::= 
      <td> Îµ | <i>digit</i>+

    <tr>
      <td><dfn>path</dfn>
      <td> ::= 
      <td> [ path-root ] Â path-rel

    <tr>
      <td><dfn>path-root</dfn> 
      <td> ::= 
      <td> <code>/</code>

    <tr>
      <td><dfn>path-rel</dfn>
      <td> ::= 
      <td> ( dir <code>/</code> )* [ file ]

    <tr class=inbetween><td colspan=3>
    If the port is not the empty string, then it must in addition be a decimal representation of 
    a natural number <var>n</var> &lt; 2<sup>16</sup> where leading zeroes are allowed.

    <tr>
    <td colspan=3>
      <p class=note> A forced <i>web-<span class=url>URL</span></i>
      will have a non-empty authority and a path-root. Moreover if it has a
      host then it will not be an opaque host as it will have been processed
      and verified to be a domain.

    <tr class=inbetween>
      <td colspan=3>Rules for the components:

    <tr>
      <td><dfn>scheme</dfn>
      <td> ::= 
      <td> <i>alpha</i> (<i>alpha</i> | <i>digit</i>
        | <code>+</code> | <code>-</code> | <code>.</code>)*

    <tr>
      <td><dfn>username</dfn>
      <td> ::= 
      <td class=nowrap> ( <i>uchar</i> | <i>pct</i> )*

    <tr>
      <td><dfn>password</dfn>
      <td> ::= 
      <td class=nowrap> ( <i>pchar</i> | <i>pct</i> )*

    <tr>
      <td><dfn>opaque-host</dfn> 
      <td> ::= 
      <td><nowrap>( <i>hchar</i> | <i>pct</i> )+</nowrap>

    <tr>
      <td><dfn>dir</dfn>
      <td> ::= 
      <td class=nowrap> ( <i>pchar</i> | <i>pct</i> )*

    <tr>
      <td><dfn>file</dfn>
      <td> ::= 
      <td class=nowrap> ( <i>pchar</i> | <i>pct</i> )+

    <tr>
      <td><dfn>query</dfn>
      <td> ::= 
      <td class=nowrap> ( <i>qchar</i> | <i>pct</i> )*

    <tr>
      <td><dfn>fragment</dfn>
      <td> ::= 
      <td class=nowrap> ( <i>fchar</i> | <i>pct</i> )*

    <tr class=inbetween>
      <td colspan=3>Using the following rule for validâ€“ <em>or</em> invalid
        percent encoded bytes:

    <tr>
      <td><dfn>pct</dfn>
      <td> ::= 
      <td class=nowrap> <i>pct-encoded-byte</i> Â |Â  <i>pct-invalid</i>


    <tr class=inbetween>
      <td colspan=3>The rules are based on the following character-sets:
    <tr><td><dfn>uchar</dfn>
      <td> :=
      <td> <i>any</i> \
        <nowrap>{Â <code>%</code>, <code>#</code>, <code>?</code>, <code>/</code>, <code>:</code>Â }</nowrap>
    <tr><td><dfn>hchar</dfn>
      <td> :=
      <td> <i>any</i> \
        {Â <code>%</code>, <code>#</code>, <code>?</code>, <code>/</code>, <code>:</code>, <code>@</code>Â }Â 
        \ { <b>u+0</b>, <code><span style=display:inline-block;width:1ch> </span></code>,
        <code>&lt;</code>, <code>&gt;</code>, <code>[</code>, <code>\</code>, <code>]</code>,
        <code>^</code>, <code>|</code> }
    <tr>
      <td><dfn>pchar</dfn>
      <td> := 
      <td> <i>any</i> \ <nowrap>{Â <code>%</code>, <code>#</code>, <code>?</code>, <code>/</code>Â }</nowrap>
    <tr>
      <td><dfn>qchar</dfn> 
      <td> := 
      <td class=-nowrap> <i>any</i> \ {Â <code>%</code>, <code>#</code>Â }
    <tr>
      <td><dfn>fchar</dfn> 
      <td> := 
      <td class=-nowrap> <i>any</i> \ {Â <code>%</code>Â }

    <!-- <tr class=inbetween>
      <td colspan=3>Where <code>/</code> depends on the <i>parser-mode</i>:
    <tr>
      <td><dfn>s</dfn>
      <td> :=
      <td> { <code>/</code> }
        Â â€”Â  for <b>generic</b> <span class=url>URL</span>s
    <tr>
      <td><dfn>s</dfn>
      <td> :=
      <td> { <code>/</code>, <code>\</code> }
        Â â€”Â  otherwise -->
    </table>

  <p>
    This grammar provides a lenient and a strict description of URL strings at once,
    as follows: A stricty valid URL string does not use the <i>pct-invalid</i>,
    nor <i>auth-drive-invalid</i> rules and it must not contain in its components any characters
    that are specified as <b class=R>R</b>, <b>T</b> or <b>F</b> for that
    component-type as per the <a href=#component-characters>Component Characters</a> section.
    Moreover, a strictly valid URL must not contain a <i>Userinfo</i> component in its
    authority.
  </div>


</section>


<!--------------------------------------------->
<section><h2 id=equivalences-and-normalisation>Equivalences and Normalisation</h2>
<!--------------------------------------------->

<p>
  This section is analogous to the section
  <a href="https://tools.ietf.org/html/rfc3986#section-6.2">Normalization and 
  Comparison</a> of <abbr class=caps>RFC</abbr>Â 3986. The
  <abbr class=caps>RFC</abbr> however, does not <em>prescribe</em> a
  particular normal form. The <abbr class=caps>WHATWG</abbr> standard
  does, however implicitly. 

<!-- <p>
  I think it is nice to define the equivalences via a congruence relation.
  The equations that follow in this section can be directed from left
  to right to obtain a set of terminating rewrite rules.
  An <i class=url>URL</i> is in normal form if no more rewrite rules can be
  applied.
-->
<!--
<h4>Normalisation Function</h4>
<p>
  A <i>normalisation function</i> for <i class=url>URL</i>s is a function
  <var>norm</var> that respects the following equation. 
<table class=grammar>
  <tr>
    <td><var>norm</var> ((<var>norm</var> <var>url<sub>1</sub></var>)  
    <i class=op>goto</i>
    (<var>norm</var> <var>url<sub>2</sub></var>))
    <td> = 
    <td><var>norm</var> (<var>url<sub>1</sub></var>  
    <td><i class=op>goto</i>
    <td><var>url<sub>2</sub></var>)
</table>
-->

<h3>Path Segment Normalisation</h3>

<p>
  Path segment normalisation involves the interpretation of
  <i>dotted-segment</i>s. Colloquially, a single-dot segment has the meaning of
  &ldquo;select the current directory&rdquo; whereas a double-dot segment has
  the meaning of &ldquo;select the parent directory&rdquo;.
  Dotted segments are defined by the following rules, where the addition of
  <code>%2e</code> and <code>%2E</code> has been motivated
  by security concerns. Again this is in accordance with
  the <abbr class=caps>WHATWG</abbr> standard.
</p>

<div class="dfn-scope +br">
<dfn style=display:none>dotted-segment</dfn>
<script class="indent grammar" type=bnf>
  dot   ::= `.` | `%2e` | `%2E`
  dots  ::= dot dot
</script>
</div>

<p>
  Path equivalence is defined by the following equations.
  The equations can be exhaustively applied from left-to-right
  to normalise an <i class=url>URL</i>. 
</p>

<table class=grammar>
  <tr>
    <td><b>drive</b>Â  <var>x</var> <code>|</code>
    <td> â‰ˆ
    <td><b>drive</b>Â  <var>x</var> <code>:</code>
  <tr>
    <td><b>dir</b>  <var>x</var>
    <td> â‰ˆ <td>Îµ <td>â€”<td> if <var>x</var> :: <i>dot</i></td>
  <tr>
    <td><b>dir</b>  <var>x</var>ãƒ»<b>dir</b> <var>y</var>
    <td> â‰ˆ <td> Îµ                                
    <td> â€” <td> if <var>y</var> :: <i>dots</i> 
      and <strong>not</strong> <var>x</var> :: <i>dots</i>
  <tr>
    <td><b>path-root</b> <code>/</code>ãƒ»<b>dir</b> <var>y</var> 
    <td> â‰ˆ <td><b>path-root</b> <code>/</code>
    <td> â€” <td> if <var>y</var> :: <i>dots</i>
</table>


<h3>Authority Normalisation</h3>
<p>
  Authority equivalence is defined by the following equations.
  Like path normalisation,
  the equations must be exhaustively applied from left-to-right
  to normalise an <i class=url>URL</i>. This has the same effect as removing
  any empty <b>port</b> or <b>password</b> component, and if the
  <span class=url>URL</span> does not have a <b>password</b> after that, 
  to also remove any empty <b>username</b> component. 
</p>

  <table>
    <!-- <tr><td><b>username</b> Îµãƒ»<b>password</b> Îµ
      <td> â‰ˆ <td>Îµ -->
    <tr><td><b>password</b> Îµ <td> â‰ˆ <td> Îµ
    <tr><td><b>userinfo</b> (<b>username</b> Îµ) <td> â‰ˆ <td> Îµ
    <tr><td><b>port</b> Îµ <td> â‰ˆ <td>Îµ
  </table>

<h3>Scheme-Based Authority Validation</h3>

<p>
  If an <i class=url>URL</i> has a scheme, then a number of additional
  requirements may be enforced on the authority; specifically these should be 
  enforced or fixed whilst resolving (as opposed to rebasing) and URL. 

<p class=todo>
  Type it out nicely

<ul>
  <li>file and web URLs must have an authority
  <li>file URL authority must not have a userinfo nor a port component
  <li>web URL must have a <em>non-empty</em> authority
  <li>file- and web URL host must not be an opaque host
</ul>    


<h3>Scheme-Based Authority Normalisation</h3>
<p>
  If an <i class=url>URL</i> has a scheme, then a number of additional
  equivalences apply to the authority. Normalisation according to these rules
  involves the removal of <em>default</em> <b>port</b>s, and similarly, 
  removing the <b>host</b> from a <i>file-<span class=url>URL</span></i> if its
  <i class=common>value</i> is <code>localhost</code>. 

  <table id=scheme-based-normalisation>
    <tr>
      <td><b>scheme</b> <code>http</code> 
      <td>ãƒ»<td><b>authority</b> (<var>xs</var>ãƒ»<b>port</b> <code>80</code>)  
      <td> â‰ˆ <td> <b>scheme</b> <code>http</code> 
      <td>ãƒ»<td><b>authority</b> <var>xs</var>
    <tr>
      <td><b>scheme</b> <code>ws</code>   
      <td>ãƒ»<td><b>authority</b> (<var>xs</var>ãƒ»<b>port</b> <code>80</code>)  
      <td> â‰ˆ <td> <b>scheme</b> <code>ws</code>   
      <td>ãƒ»<td><b>authority</b> <var>xs</var>
    <tr>
      <td><b>scheme</b> <code>ftp</code>  
      <td>ãƒ»<td><b>authority</b> (<var>xs</var>ãƒ»<b>port</b> <code>21</code>)  
      <td> â‰ˆ <td> <b>scheme</b> <code>ftp</code>  
      <td>ãƒ»<td><b>authority</b> <var>xs</var>
    <tr>
      <td><b>scheme</b> <code>wss</code>  
      <td>ãƒ»<td><b>authority</b> (<var>xs</var>ãƒ»<b>port</b> <code>443</code>) 
      <td> â‰ˆ <td> <b>scheme</b> <code>wss</code>  
      <td>ãƒ»<td><b>authority</b> <var>xs</var>
    <tr>
      <td><b>scheme</b> <code>https</code>
      <td>ãƒ»<td><b>authority</b> (<var>xs</var>ãƒ»<b>port</b> <code>443</code>) 
      <td> â‰ˆ <td> <b>scheme</b> <code>https</code>
      <td>ãƒ»<td><b>authority</b> <var>xs</var>
    <tr>
      <td><b>scheme</b> <code>file</code> 
      <td>ãƒ»<td><b>authority</b> (<b>host</b> <code>localhost</code>)          
      <td> â‰ˆ <td> <b>scheme</b> <code>file</code> 
      <td>ãƒ»<td><b>authority</b> Îµ
  </table>

  <p>
    These rules apply in combination with the following rule that states that
    <b>scheme</b> equivalence is case-insensitive. 
    <table>
      <tr>
        <td colspan=3><b>scheme</b> <var>scheme</var> 
        <td> â‰ˆ 
        <td colspan=3><b>scheme</b> (lowercase <var>scheme</var>)
    </table>



<!-- <h3>Percent Coding Normalisation</h3> -->



</section>



<section>
<h2 id=printing>Printing</h2>
<!------------------------->

<p>
  Printing is the process of converting an <i class=url>URL</i> to an
  <i><span class=url>URL</span>-string</i>. 
  Printing can be stratified into the following three phases:
<ol>
  <li>
    Normalising the <i class=url>URL</i> for printing. 
  <li>
    Converting each of the <i class=common>component</i>s of the <i class=url>URL</i> to a
    <i class=common>string</i>.
  <li>
    Composing the final <i class=common><span class=url>URL</span>-string</i> from the printed
    <i class=common>component</i>s.
</ol>


<h3>Normalise for Printing</h3>

<p>
  To print an <i class=url>URL</i>, it must first be
  subjected to an additional normalisation operation, and it must be percent encoded
  as follows. 

<h4>Normalise for Printing</h4>
<p>
  If an <i class=url>URL</i> does <em>not</em> have a <b>drive</b> nor an <b>authority</b>
  but it <em>does</em> have an empty first <b>dir</b> component (<b>dir</b> Îµ) then it must be
  <dfn>normalised for printing</dfn> by inserting a component (<b>dir</b> <code>.</code>)
  immediately before its first <b>dir</b> component.
<p>
  Otherwise, if the first component of an <span class=url>URL</span> is a <b>dir</b> or
  a <b>file</b> component and its value <var>value</var> starts with a scheme-like string, i.e.

<p class="center nobr">
  <var>value</var> :: <i>alpha</i> (<i>alpha</i> | <i>digit</i> | <code>+</code>
    | <code>-</code> | <code>.</code>)* <code>:</code> <i>any</i>*,

<p>
  then the first occurrence of <code>:</code> in <var>value</var> must be replaced with its percent-encoding
  <code>%3A</code>.

<p>
  This additional normalisation step is necessary because it is not possible to represent
  the affected <i class=url>URL</i> as an <i class=common><span class=url>URL</span>-string</i>
  otherwise.

<p>
  Consider for example the <i class=url>URL</i>
  (<b>path-root</b> <code>/</code>)ãƒ»(<b>dir</b> Îµ)ãƒ»(<b>file</b> <code>foo</code>). 
  Printing this <span class=url>URL</span> without an additional normalisation step
  would result in <code>//foo</code> which represents the <span class=url>URL</span> 
  (<b>authority</b> (<b>host</b> <code>foo</code>)) instead. 

<p class=todo>
  There is a similar issue around URLs with drive letters,
  but these issues are not properly addressed in the current WHATWG standard,
  making it difficult for us to prescribe appropriate counter measures.
  
<!-- <ul>
  <li>
    To print to an <abbr class=caps>
    </abbr>
    <i><span class=url>URL</span>-string</i>,
    percent encode <i>any</i> \ <i>printable-<abbr class=caps>ASCII</abbr></i>
  <li>
    Otherwise percent encode <i>control-c0</i>, <i>del-c1</i>,
    <i>surrogate</i>s and <i>non-char</i>s.
  <li>
    In addition percent encode a subset of
    <i>printable-<abbr class=caps>ASCII</abbr></i>, depending on the
    <i class=common>component</i>, as indicated by the percent coding table.
</ul> -->


<h3>Printing URLs</h3>

<p>
  To convert an <i>Authority</i> to an <i>Authority</i>-string, replace each of the sub-components
  with their component-value concatenated with their prefixâ€“ or postfix-sigil, if any.
  This results in a sequence of strings, which is converted to the final result by concatenating them in order.

<p>
  To convert an <i class=url>URL</i> to an <span class=url>URL</span>-string, first convert the value of
  its <b>authority</b> component (if any) to an <i>Authority</i>-string.
  Then continue to replace each component with their component-value concatenated with their identifying sigil, if any.
  This results in a sequence of strings, which is converted to a single string by simply concatenating them in order.
</section>


<!------------------------->


<section>
  
  <h2 id=concluding>Concluding</h2>

  <p>
    This final section specifies the behaviour of a 
    <i>parse-resolve-and-normalise</i> operation that characterises the behaviour of the
    &lsquo;<a href="https://url.spec.whatwg.org/#concept-basic-url-parser">basic
    <span class=url>URL</span> parser</a>&rsquo;
    as described in the <abbr class=caps>WHATWG URL</abbr> standard.

  <div class=note>
    It's easy!<br>
    parse-resolve-and-normalise (string, base) :=
    <ul>
      <li>
        Preprocess string 
      <li>
        Detect the parser mode, with the fallback mode as indicated by the base
      <li>
        Parse the preprocessed string according to the grammar to obtain url1
      <li>
        Force resolve url1 against base
      <li>
        Normalise and percent encode the result. 
    </ul>

    <p>
      That results in an URL-structure.
      One can then wrap around that to describe the URL class of web browsers:

    <ul>
      <li>
        The href getter returns the printed URL.
      <li>
        The protocol getter returns the scheme + <code>:</code> or Îµ if absent.
      <li>
        The username and password getters return Îµ if absent or the value of the
        corresponding component otherwise
      <li>
        The host getter returns Îµ if absent, the value
        of the <b>host</b> if the port is absent, and the value
        of the <b>host</b> + <code>:</code> + the value of the <b>port</b> otherwise.
      <li>
        The hostname getter returns Îµ if the URL has no host, otherwise it returns the value
        of the <b>host</b>.
      <li>
        pathname (â€¦)
      <li>
        The search getter returns Îµ if the URL has no <b>query</b>, otherwise it
        returns <code>?</code> + the value of the <b>query</b>. 
      <li>
        The hash getter returns returns Îµ if the URL has no <b>fragment</b>, 
        otherwise it returns <code>#</code> + the value of the <b>fragment</b>. 
    </ul>

  </div>


</section>
</article>
<br class=clear>
</main>
</body>
</html>