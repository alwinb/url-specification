<!DOCTYPE html>
<html lang="en" class="-debug">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>URL Specification</title>
  <link rel="stylesheet" href="style/base.css">
  <link rel="stylesheet" href="style/style.css">
  <script src="miniurl/miniurl.js"></script>
  <script src="scripts/main.js"></script>
</head>
<body>

<header>
  <!--  -->
</header>

<div id=tools>
  <div id=menu>
  <!-- ðŸŒ³ðŸ¦’ðŸŒ¿ðŸŒ²ðŸ˜ðŸŒ±ðŸ ðŸ‚ðŸŒ¾ ðŸºðŸ¾ðŸ¦ðŸ‚ -->  
  <div id=icon>ðŸŒ²</div>
  <ul>
    <li><a href=#url-specification>Introduction</a></li>
    <li><a href=#preliminaries>Preliminaries</a></li>
    <li><a href=#url-model><span class=url>URL</span> Model</a></li>
    <li><a href=#parsing>Parsing</a></li>
    <li><a href=#host-processing >Host processing</a></li>
    <li><a href=#reference-resolution >Reference Resolution</a></li>
    <li><a href=#equivalences-and-normalisation >Normalisation</a></li>
    <li><a href=#percent-coding >Percent Coding</a></li>
    <li><a href=#validation >Validation</a></li>
    <li><a href=#printing>Printing</a></li>
  </ul>
  </div>
  <div id=tooltip></div>
</div>

<article>
<h1 id=url-specification>URL Specification</h1>


<!----------------------------->
<section class=-short>
<h2 class=-toc-exclude style=display:none>URL Specification</h2>
<!----------------------------->
  <p>
    This document provides a concise formal specification of
    <span class=url>URL</span>s and the language of
    <span class=url>URL</span>s. It is a <em>reverse specification</em> of the
    <a href="https://url.spec.whatwg.org/"><abbr class=-caps>WHATWG-URL</abbr>
      standard</a>.
  <p class=-inbetween>
    The goals of this document are,
  <ul class=-prose>
    <li>
      To provide a modular, concise formal specification of
      <span class=url>URL</span>s that is behaviourally equivalent with, and covers
      all of the <a href="https://url.spec.whatwg.org/"
      ><abbr class=-caps>WHATWG-URL</abbr> standard</a> with the one exception
      being their specification of the web <abbr class=-caps>API</abbr>'s
      setters and the url-encoded form format.
    <li>
      To define a general model for <span class=url>URL</span>s that can
      express relative references and to define reference resolution by means
      of a number of elementary operations, in such a way that the end result
      is compatible with the
      <abbr class=-caps>WHATWG URL</abbr> standard.
    <li>
      To enable and support efforts <em>towards</em> a single
      <strong><em>Unified <span class=url>URL</span> Standard</em></strong>
      that includes a normative specification of <span class=url>URL</span>
      handling by web browsers and that resolves the incompatibilities between
      <a href="https://tools.ietf.org/html/rfc3986"><abbr
         class=-caps>RFC</abbr> 3986</a>,
      <a href="https://tools.ietf.org/html/rfc3987"><abbr
         class=-caps>RFC</abbr> 3987</a> and the
      <a href="https://url.spec.whatwg.org/"><abbr
         class=-caps>WHATWG-URL</abbr> standard</a>.
    <li>
      To provide the authors of the <abbr class=-caps>WHATWG</abbr> standard
      with a support document that they can use as a reference in their efforts
      to standardise the behaviour of web browsers.
  </ul>
</section>


<!----------------------------->
<section class=-short>
<h2 class=-toc-exclude>Status of this document</h2>
<!----------------------------->
  <ul>
    <li>
      This is version 0.2.0 of the specification. This is a development 
      version. 
    <li>
      The versioning scheme is specified by
      <a href="https://semver.org/spec/v2.0.0.html">Semantic Versioning</a>.
    <li>
      This document is licensed under a
      <a href="https://creativecommons.org/licenses/by-sa/2.0/">
      Creative Commons - <abbr class=-caps>CC BY-SA</abbr> 2.0</a> license. 
    <li>
      The development of this specification can be discussed on
      <a href="https://github.com/alwinb/url-specification">GitHub</a>. 
  </ul>
</section>


<!----------------------------->
<section class=-short><h2 class=-toc-exclude>Structure of this document</h2>
<!----------------------------->
  <p>
    As of this writing, this specification has a compact format that is focused
    specifically on the definition and specification of <span
     class=url>URL</span>s and operations on <span class=url>URL</span>s. 
    It does not include a discussion of their history or their use in
    various contexts. It does contain valuable non-normative references to
    <a href="https://tools.ietf.org/html/rfc3986"
    ><abbr class=-caps>RFC</abbr> 3986</a> that can be
    followed for additional information about the concepts involved.

  <p class=-inbetween>
    The sections are laid out as follows.
  <ul id=toc>
    <!-- auto generated -->
  </ul>
</section>


<!----------------------------->
<section><h2>Preliminaries</h2>
<!----------------------------->
  <p>
    This section introduces basic concepts and notational conventions upon 
    which the rest of the specification is built. 


  <div class="dfn-scope +br">
  <h4>Sequences</h4>
    <p>
      This specification uses an algebraic notation for <dfn>sequence</dfn>s
      that makes no distinction between one-element sequences and their first
      element. It uses the following notation:
    <ul class=-inbetween>
      <li>
        The empty sequence is denoted by Îµ. 
      <li>
        The concatenation of two sequences <var>S</var> and <var>T</var> is
        denoted by <var>S</var>ãƒ»<var>T</var>. 
    </ul>
  </div>    

  <p style=margin-top:-.5rem>
    Parentheses are used for disambiguation and as visual aides. Paired 
    parentheses are not part of a sequence-constructing operation. 

  <div class="dfn-scope +br">
    <dfn style=display:none>type</dfn>
    <h4>Tokens</h4>
    <p>
      The word <dfn>token</dfn> is used throughout this specification to mean a
      tagged value, denoted by (<var>type</var> <var>value</var>), where
      <var>type</var> is taken from a predefined set of
      <dfn>token-type</dfn>s.
    The <i class=common>value</i> of a <i class=common>token</i> may be a
    <i class=common>sequence</i> of
    <i class=common>token</i>s itself, in which case the
    <i class=common>token</i> may be referred
    to as a <dfn>compound-token</dfn> for clarity.
    <!--and the tokens present in its value may be referred to as
    <dfn>sub-token</dfn>s.-->
    <!-- add to dfn index -->
    <!-- TODO I want to be able to add alt-name attributes to the dfn tags-->
    <div style=display:none><dfn>value</dfn></div>
  </div>
  <p>
    Both <i>token-type</i> constants and their corresponding
    <i class=common>token</i>-constructing operator are typeset in boldface.
    For example, <b class=noindex>scheme</b> denotes a <i>token-type</i>, whilst
    <span class=-nowrap>(<b class=noindex>scheme</b> <var>value</var>)</span>
    denotes a <i>token</i>. Again, parentheses are used to disambiguate and as
    visual aides. They are not part of the
    <i class=common>token</i>-constructing operator. 
  <p>
    When a collection of <i class=common>token</i>s contains exactly one
    <i class=common>token</i> (<var>tag</var> <var>value</var>) for a given
    <i class=common>tag</i>, then
    the <i class=common>tag</i> may be used to refer to its
    <i class=common>value</i> directly. For
    example, given a <i class=common>sequence</i> of <i class=common>token</i>s
    S := (<b class=noindex>dir</b> <var>x</var>ãƒ»<b
       class=noindex>file</b> <var>y</var>ãƒ»<b 
       class=noindex>query</b> 
    <var>z</var>), the phrase
    &ldquo;the <b class=noindex>query</b> of S&rdquo; identifies the
    <i class=common>value</i> <var>z</var> whereas the phrase &ldquo;the
    <b class=noindex>query</b> <i class=common>token</i> of
    S&rdquo; identifies 
    <span class=-nowrap>(<b class=noindex>query</b> <var>z</var>)</span>.


  <h4>Strings and Code-Points</h4>
    <p class=-br>
      For the purpose of this specification,
    <ul class=dfn-scope>
      <li>
        A <dfn>string</dfn> is a <i class=common>sequence</i> of
        <i>character</i>s.
      <li>
        A <dfn>character</dfn> is a single
        <a href="https://www.unicode.org/versions/latest/">Unicode</a>
        <i>code point</i>.
      <li>
        A <dfn>code point</dfn>, is a natural number <span
          class=-nowrap><var>n</var> â‰¤ 1114111</span>.
      <li>
        The <dfn>empty string</dfn> is a <i class=common>sequence</i> of zero
        code points. It is denoted by Îµ. 
    </ul>
    <p>
      Code points are denoted by a number in <em>hexadecimal</em> notation
      preceded by <b class=noindex>u+</b>, in boldface. In addition, code points
      that correspond to <i class=common>printable <abbr
        class=-caps>ASCII</abbr> characters</i> are
      often denoted by their corresponding glyph, typeset in monospace and on a
      screened background.
      For example, <b>u+41</b> and <code>A</code> denote the same
      code point. Strings that contain only
      <i class=common>printable <abbr class=-caps>ASCII</abbr> characters</i>
      are often denoted as a connected sequence of glyphs, typeset likewise.
    <p>
      The <dfn class=common>printable <abbr
        class=-caps>ASCII</abbr> characters</dfn> are
      codepoints in the range <b>u+20</b> to <b>u+7E</b>, inclusive. Note that
      this includes the space <i class=common>character</i> <b>u+20</b>.


  <h4>Character Sets</h4>
  <p>
    <span class=dfn-scope>A <dfn>character-set</dfn> is a set of
      <i>character</i>s. 
    A <dfn>character-range</dfn> is the largest 
    <i class=common>character-set</i> that includes a given least
    <i class=common>character</i> <var>c</var> and a greatest
    <i class=common>character</i> <var>d</var>.
    Such a <i>character-range</i> is denoted by
    <span class=-nowrap>{Â <var>c</var>â€“<var>d</var>Â }.</span> 
    The union of e.g. <span class=-nowrap>{Â <var>a</var>â€“<var>b</var>Â }</span>
    and <span class=-nowrap>{Â <var>c</var>â€“<var>d</var>Â }</span>, is denoted by
    <span class=-nowrap>{Â <var>a</var>â€“<var>b</var>,Â 
      <var>c</var>â€“<var>d</var>Â }</span>, and this
    notation is generalised to <var>n</var>-ary unions. 
    Common <i class=common>character-set</i>s that are 
    used throughout this specification are defined below: 

  <table class="grammar">
    <tr>
      <td><dfn>any</dfn> 
      <td> := 
      <td> { <b>u+0</b>â€“<b>u+10FFFF</b> }
    <tr>
      <td><dfn>control-c0</dfn> 
      <td> := 
      <td> { <b>u+0</b>â€“<b>u+1F</b> }
    <tr>
      <td><dfn>c0-space</dfn> 
      <td> := 
      <td> { <b>u+0</b>â€“<b>u+20</b> }
    <tr>
      <td><dfn>printable-<abbr class=-caps>ASCII</abbr></dfn>
      <td> := 
      <td> { <b>u+20</b>â€“<b>u+7E</b> } â€” i.e. { <code><span style=width:1ch;display:inline-block;padding:0> </span></code>â€“<code>~</code> }
    <tr>
      <td> <dfn>octal-digit</dfn> 
      <td> := 
      <td> { <code>0</code>â€“<code>7</code> }
    <tr>
      <td><dfn>digit</dfn> 
      <td> := 
      <td> { <code>0</code>â€“<code>9</code> }
    <tr>
      <td><dfn>hex-digit</dfn> 
      <td> := 
      <td> { <code>0</code>â€“<code>9</code>,Â 
        <code>A</code>â€“<code>F</code>,Â  <code>a</code>â€“<code>f</code> }
    <tr>
      <td> <dfn>digit-nonzero</dfn> 
      <td> := 
      <td> { <code>1</code>â€“<code>9</code> }
    <tr>
      <td><dfn>alpha</dfn> 
      <td> := 
      <td> { <code>A</code>â€“<code>Z</code>,Â 
        <code>a</code>â€“<code>z</code> }
    <tr>
      <td><dfn>del-c1</dfn> 
      <td> := 
      <td> { <b>u+7F</b>â€“<b>u+9F</b> }
    <tr>
      <td><dfn>control-c1</dfn> 
      <td> := 
      <td> { <b>u+80</b>â€“<b>u+9F</b> }
    <tr>
      <td><dfn>latin-1</dfn> 
      <td> := 
      <td> { <b>u+A0</b>â€“<b>u+FF</b> }
    <tr>
      <td><dfn>surrogate</dfn> 
      <td> := 
      <td> { <b>u+D800</b>â€“<b>u+DFFF</b> }
  </table>


  <h4>Grammars</h4>
  <p>
    The notation <var>name</var> ::= <var>expression</var> is used to define
    a production rule of a grammar, where the <i>expression</i> uses
    square brackets ( [ _ ] ) <strong>for optional rules</strong>, a postfix
    star ( * ) for zero-or-more, a postfix plus ( + ) for one-or-more, an infix
    vertical line ( | ) for alternatives, monospaced type for literal
    <i class=common>string</i>s
    and an epsilon ( Îµ ) for the empty string. Parentheses are used for 
    grouping and disambiguation. 


  <h4>Pattern Matching</h4>
  <p>
    The shorthand notation <var>string</var> :: <var>rule</var> is used to
    express that a <i class=common>string</i> <var>string</var> can be
    generated by the production rule <var>rule</var> of a given grammar.
    <br>Likewise, the notation 
    <var>string</var> :: <var>expression</var> is used to express that 
    <var>string</var> can be generated by <var>expression</var>.

</section>


<!------------------------>
<section><h2>URL Model</h2>
<!------------------------>
<p>
  An <i class=url>URL</i> is a special kind of ordered list that is
  subject to a number of additional constraints. The ordering of the list is
  analogous to the hierarchical syntax of an URI as described in
  <a href="https://tools.ietf.org/html/rfc3986#section-1.2.3">Hierarchical
  Identifiers</a> in <abbr class=-caps>RFC</abbr> 3986.
<p>
  It is important to stress the distinction between an
  <i class=url>URL</i> and an <i><span class=url>URL</span>-string</i>.
<br>
  <span class=dfn-scope>
    An <i class=url>URL</i> is a <em>structure</em>, indeed a special
    kind of ordered list, whereas an
    <dfn><span class=url>URL</span>-string</dfn> is a
    special kind of <i>string</i> that <em>represents</em> an
    <i class=url>URL</i></span>. Conversions between <i class=url>URL</i>s
  and <i class=common><span class=url>URL</span>-string</i>s are described in
  the sections <a href="#parsing">Parsing</a>
  and <a href="#printing">Printing</a>.

  <div class=dfn-scope>
  <h4>URL</h4>
    <p>
      An <dfn class=url>URL</dfn> is a <i>sequence</i> of
      <i>token</i>s that occur in ascending order by <i>token-type</i>,
      where <i>token-type</i> is taken from
      the ordered set: 
    <p class="-center">
      <b>scheme</b> &lt; <b>authority</b> &lt; <b>drive</b>
      &lt; <b>path-root</b> &lt; <b>dir</b> &lt; <b>file</b>
      &lt; <b>query</b> &lt; <b>fragment</b>.
    <p>
      <i class=url>URL</i>s are subject to the following constraints:
    </div>

    <ul>
      <li>
        An <i class=url>URL</i> contains at most one
        <i class=common>token</i> per <i class=common>type</i>, 
        except for <b>dir</b> <i class=common>token</i>s, of which it may have
        any finite amount.
      <li class=dfn-scope><dfn style=display:none>path-root-constraint</dfn>
        If an <i class=url>URL</i> has an <b>authority</b> or a
        <b>drive</b> <i class=common>token</i>, and it has a <b>dir</b> or a
        <b>file</b> token, then it also has a <b>path-root</b>
        <i class=common>token</i>.
    </ul>
    <ul>
      <li class=dfn-scope>
        The <dfn><b>scheme</b></dfn> of an <i class=url>URL</i>,
        if present, is a <i class=common>string</i>
        <span class=rule><var>scheme</var> :: <i>alpha</i> (<i>alpha</i>
          | <i>digit</i> | <code>+</code> | <code>-</code>
          | <code>.</code>)*</span>
      <li class=dfn-scope>
        The <dfn><b>authority</b></dfn> of an <i class=url>URL</i>,
        if present, is
        an <i>Authority</i> â€” to be defined below.
      <li class=dfn-scope>
        The <dfn><b>path-root</b></dfn> of an <i class=url>URL</i>,
        if present, is the string <code>/</code>. 
      <li class=dfn-scope>
        The <dfn><b>drive</b></dfn> of an <i class=url>URL</i>,
        if present, is a
        <i class=common>string</i> <span class=-nowrap><var>drive</var> ::
          <i>alpha</i> (<code>:</code> | <code>|</code>)</span>
      <li class=dfn-scope>
        The <dfn><b>file</b></dfn> of an <i class=url>URL</i>,
        if present, is a nonempty string.
      <li>
        For all other tokens present, the tokens&rsquo; values are
        <i class=common>string</i>s.
      </ul>
      <ul style=display:none>
        <li class=dfn-scope>
          A <dfn><b>dir</b></dfn> token, is a token (<b>dir</b> <var>name</var>)
          where <var>name</var> is a string.
        <li class=dfn-scope>
          The <dfn><b>query</b></dfn> of an <i class=url>URL</i>,
          if present, is a string.
        <li class=dfn-scope>
          The <dfn><b>fragment</b></dfn> of an <i class=url>URL</i>,
          if present, is a string.
      </ul>
    </ul>


    <div class="dfn-scope +br">
    <h4>Base-URL</h4>
    <p>
      A <dfn>base-<span class=url>URL</span></dfn> is an <i>
      <i class=url>URL</i></i> that has a <i><b>scheme</b></i>
      and that has in addition, an <i><b>authority</b></i> or a
      <i><b>path-root</b></i>.
    </div>


    <div class="dfn-scope +br">
    <h4>Web-URL</h4>
      <p class=-br>
        A <dfn>web-<span class=url>URL</span></dfn> is an
        <i class=url>URL</i> that has a <i>web-<b>scheme</b></i>.
        <!-- A <dfn>non-special <span class=url>URL</span></dfn> is an
        <span class=url>URL</span> that is not <i>special</i>. -->
        A <dfn>web-scheme</dfn> is a <i class=common>string</i>
        <var>scheme</var> such that
        <!-- <span class=-nowrap>lowercase (<var>scheme</var>)
            :: <code>http</code> [<code>s</code>]
            Â |Â  <code>ws</code> [<code>s</code>]
            Â |Â   <code>ftp</code>. -->
        <span class=-nowrap>lowercase (<var>scheme</var>) ::
            <code>http</code> | <code>https</code> | <code>ws</code> |
            <code>wss</code> | <code>ftp</code>.
    </div>

    <div class="dfn-scope +br">
    <h4>File-URL</h4>
      <p>
        A <dfn>file-<span class=url>URL</span></dfn> is an
        <i class=url>URL</i> that has a <i>file-<b>scheme</b></i>.
        A <dfn>file-<b>scheme</b></dfn> is a <i class=common>string</i>
        <var>scheme</var> such that
        <span class=-nowrap>lowercase (<var>scheme</var>) :: <code>file</code>. 
    </div>



    <div class=dfn-scope>
      <dfn style=display:none>authority</dfn>
    <h4>Authority</h4>
    <p class=-br>
      An <dfn>Authority</dfn> is a sequence of tokens ordered by their type, 
      taken from the ordered set:

    <p class="-center">
      <b>username</b> &lt; <b>password</b> &lt; <b>host</b> &lt; <b>port</b>.

    <p class=-br>
      Authorities are subject to the following constraints:
    </div>

    <ul>
      <li>
        Authorities have at most one <i class=common>token</i> per
        <i class=common>type</i>.
      <li>
        If an Authority has a <b>password</b> <i class=common>token</i> then it
        also has a <b>username</b> <i class=common>token</i>.
      <li>
        If an Authority has a <b>username</b> or a <b>port</b>
        <i class=common>token</i> then it also has a <b>host</b>
        <i class=common>token</i>.
    </ul>

    <p class=-br>
      The <i class=common>token</i>s of an Authority are subject to the
      following conditions:
    <ul>
      <li class=dfn-scope>
        The <dfn><b>host</b></dfn> of an Authority is a <i>Host</i> â€” to be 
        defined below.
      <li class=dfn-scope>
        The <dfn><b>port</b></dfn> of an Authority, if present, is either the
        empty string Îµ, or a natural number <var>n</var> &lt; 2<sup>16</sup>.
      <li class=dfn-scope>
        For all other <i class=common>token</i>s present, the
        <i class=common>token</i>s' <i class=common>value</i>s
        are <i class=common>string</i>s.
    </ul>


  <div class=dfn-scope>
    <h4>Host</h4>
    <p class=-br>
      A <dfn>Host</dfn> is either
    <ul>
      <li>
        An ipv6-address,
      <li>
        An opaque-host, which is a <i class=common>string</i>
        <var>host</var> :: <i class=rule>opaque-host</i>
      <li>
        An ipv4-address, or
      <li>
        A domain-name.
    </ul>
  </div>

  <h3>Additional Constraints</h3>
  <p class=-br>
    If an <i class=url>URL</i> <var>url</var> has a <b>scheme</b> then 
    it is subject to two additional constraints:
    <ul>
  <li>
    If <var>url</var> is <strong>not</strong> a
    <i>file-<span class=url>URL</span></i> 
    then it must not have a <b>drive</b> <i class=common>token</i>.
  <li>
    If <var>url</var> <strong>is</strong> a 
    <i>file-<span class=url>URL</span></i>, and it has an <b>authority</b>,
    then the authority must not contain a <b>username</b>, <b>password</b> or
    <b>port</b>.
</ul>
</section>


<!------------------------>
<section><h2>Parsing</h2>
<!------------------------>
  <!--<ul>
    <li>
      An URL-string is a string that represents an URL.
    <li>
      There are strings that are not URL strings.
    <li>
      It is possible for a single URL to be represented by more than one URL
      string.
    <li>
      URL strings are further divided into valid URL strings and invalid URL
      strings.
  </ul>-->

  <p>
    Parsing is the process of converting an
    <i><span class=url>URL</span>-string</i> to an <i class=url>URL</i>. 
    <br>
    Parsing is stratified into the following phases:

  <ol>
    <li>Preprocessing.
    <li> Selecting a parser mode.
    <li> Parsing.
    <li> Decoding and parsing the host.
  </ol>

  <h3>Preprocessing</h3>
  <p class=-br>
    Before parsing, preprocess the input string <var>input</var> as follows:
  <ul>
    <li>
      Remove all leading and trailing <i>c0-space</i>
      <i class=common>character</i>s from <var>input</var>.
    <li>
      Remove all <b>u+9</b> (tab), <b>u+A</b> (line-feed) and <b>u+D</b>
      (carriage-return) <i class=common>character</i>s from <var>input</var>.
  </ul>

  <h3>Parser modes</h3>
  <p>
    Unfortunately, <i class=url>URL</i>-parsing depends slightly on the
    <b>scheme</b> of the <i class=url>URL</i> being parsed. 
    This has the unfortunate consequence that the parsing of scheme-less
    <i class=url>URL</i>s is ambiguous. The ambiguity can be resolved by 
    explicitly specifying a <i>parser-mode</i>.
    The <i class=common>parser-mode</i> only influences how scheme-less
    <i class=url>URL</i>s are parsed.

  <div class="dfn-scope +br">
  <h4>Parser Mode</h4>
    <p>
      There are three distinct <dfn>parser-mode</dfn>s:
    <p class="-center">
      <dfn><b>web-mode</b></dfn>,Â 
      <dfn><b>file-mode</b></dfn>,Â and
      <dfn><b>generic-mode</b></dfn>.
  </div>

  <p>
    In practice, it is possible to begin parsing with a supplied
    <i class=common>parser-mode</i>, and to update the
    <i class=common>parser-mode</i> whilst parsing, as soon as a
    <i class=common>scheme</i> has been detected. 
    <br>
    For the purpose of the specification however, it is useful to implement
    the mode detection as a separate step as follows. 

  <div class="dfn-scope +br">
  <h4>Mode Detection</h4>
    <p>
      The <i>updated-parser-mode</i>
      (<var>supplied-mode</var> <dfn class=fn>updated-for</dfn>
       <var>input-string</var>) is defined as follows:
    <p class=-inbetween>
      Let <var>magic</var> be the first <var>n</var> characters of
      <var>input-string</var>, with <var>n</var> being the least of 6 and the
      length of <var>input-string</var>. 
      The <dfn>updated-parser-mode</dfn> is then defined to be:
      <ul>
        <li>
          <b>file-mode</b> â€” ifÂ  (lowercase <var>magic</var>) :: <span class=rule><code>file</code> <code>:</code> <i>any</i>*</span>
        <li>
          <b>web-mode</b> â€” ifÂ  (lowercase <var>magic</var>) :: <span class=rule>(<code>http</code> | <code>https</code> | <code>ws</code> | <code>wss</code> | <code>ftp</code>) <code>:</code> <i>any</i>*</span>
        <li>
          <b>generic-mode</b> â€” ifÂ  <var>input</var> :: <span class=rule><i>alpha</i> (<i>alpha</i> | <i>digit</i> | <code>+</code> | <code>-</code> | <code>.</code>)*<code>:</code> <i>any</i>*</span>
        <li>
          <var>supplied-mode</var> â€” otherwise. 
      </ul>
    </div>

    <!-- In <b>special</b> mode, the s subscripted rules must be used instead
      of their unsubscripted counterparts, whenever available. -->

  <h3>URL Grammar</h3>
    <p>
      This section specifies a parameterised grammar for
      <i>file-<span class=url>URL</span></i>s,
      <i>web-<span class=url>URL</span></i>s, and generic
      <i class=url>URL</i>s at once.
      The grammar is parameterised by a <i>parser-mode</i>. 
      Thus, it contains a number of rules that are modified depending on the
      <i class=common>parser-mode</i>. Specifically, 
      <span class=-nowrap><span class=-caps>F</span>-subscripted</span>
      rules must be used in <b>file-mode</b> and 
      <span class=-caps>S</span>-subscripted rules must be used in both
      <b>file-mode</b> and in <b>web-mode</b>. 

    <table class=grammar>
      <!-- <tr><td>url 
        <td> ::= 
      <td> [ scheme <code>:</code> ] [ s s authority ] [ path-root ] (dir s)* [ file ] [ <code>?</code> query ] [ <code>#</code> fragment ] -->
      <tr>
        <td>url 
        <td> ::= 
        <td> [ scheme <code>:</code> ] (<i>auth-path</i> | <i>path</i>)
          [ <code>?</code> query ] [ <code>#</code> fragment ]
      <tr>
        <td><dfn>auth-path</dfn> 
        <td> ::= 
        <td> s s authority [ path-root [ dir s ]* [ file ] ]
      <tr>
      <td><dfn>path</dfn>
        <td> ::= 
        <td> [ path-root ] path-rel

      <tr class=-inbetween>
        <td colspan=3>Modified <i>auth-path</i> rule in <b>file-mode</b>:
      <tr>
        <td>auth-path<sub>F</sub><dfn style=display:none>auth-path</dfn>
        <td> ::= 
        <td> auth-drive [ path-root [ dir s ]* [ file ] ]

      <tr>
        <td>auth-drive
        <td> ::= 
        <td> [ s [s] ] drive | s s host [ s drive ]

      <tr class=-inbetween>
        <td colspan=3>This refers to the following rules:

      <tr>
        <td>scheme 
        <td> ::= 
        <td> <i>alpha</i> (<i>alpha</i> | <i>digit</i> | <code>+</code> | <code>-</code> | <code>.</code>)*

      <tr>
        <td>authority <td> â€” <td> is defined in the next subsection,
      <tr>
        <td>host <td> â€” <td> likewise
      <tr>
        <td>drive 
        <td> ::= 
        <td> <i>alpha</i> (<code>:</code> | <code>|</code>)
      <tr>
        <td><dfn>path-root</dfn> 
        <td> ::= 
        <td> <i>s</i>
      <tr>
        <td>dir 
        <td> ::= 
        <td> <i>pchar</i>*
      <tr>
        <td>file 
        <td> ::= 
        <td> <i>pchar</i>+
      <tr>
        <td>query 
        <td> ::= 
        <td> <i>qchar</i>*
      <tr>
        <td>fragment 
        <td> ::= 
        <td> <i>any</i>*

      <tr class=-inbetween>
        <td colspan=3>
          These rules are based on the following character-sets:
      <tr>
        <td><dfn>s</dfn> 
        <td> ::= 
        <td> { <code>/</code> }
      <tr>
        <td><dfn>pchar</dfn>
        <td> := 
        <td> <i>any</i> \ { <code>/</code>, <code>#</code>, <code>?</code> }
      <tr>
        <td><dfn>qchar</dfn> 
        <td> := 
        <td> <i>any</i> \ { <code>#</code> }

      <tr class=-inbetween>
        <td colspan=3>These <i class=common>character-set</i>s are
          modified in <b>file-mode</b> and in <b>web-mode</b>:
      <tr><td>s<sub>S</sub> <dfn style=display:none>s</dfn>
        <td> ::= 
        <td> { <code>/</code>, <code>\</code> }
      <tr><td>pchar<sub>S</sub> <dfn style=display:none>pchar</dfn>
        <td> :=
        <td> <i>any</i> \ { <code>/</code>, <code>\</code>, <code>#</code>, <code>?</code> }
    </table>

  <h3>Authority Grammar</h3>
    <table class=grammar>
      <tr><td><dfn>authority</dfn> 
        <td> ::= 
        <td> Îµ Â |Â  [ credentials <code>@</code> ] <i>host</i> [ <code>:</code> port ]
      <tr><td>credentials 
        <td> ::= 
        <td> username [ <code>:</code> password ]

      <tr class=-inbetween><td colspan=3>This refers to the following rules:

      <tr><td>username 
        <td> ::= 
        <td> <i>uchar</i>*
      <tr><td>password 
        <td> ::= 
        <td> <i>pchar</i>*
      <tr><td><dfn>host</dfn> 
        <td> ::= 
        <td> <code>[</code> ip6-address <code>]</code> | <i>opaque-host</i>
      <tr><td><dfn>opaque-host</dfn> 
        <td> ::= 
        <td> <i>hchar</i>+
      <tr><td><dfn>port</dfn> 
        <td> ::= 
        <td> Îµ | <i>digit</i>+

      <tr class=-inbetween>
        <td colspan=3>These rules are based on the following character-sets:

      <tr><td><dfn>uchar</dfn>
        <td> :=
        <td> <i>pchar</i> \ { <code>:</code> }
      <!-- <tr><td>hchar <td> := <td> pchar \ { <code>@</code>, <code>:</code> } -->
      <tr><td><dfn>hchar</dfn>
        <td> :=
        <td> <i>any</i> \ { <b>u+0</b>, <b>u+9</b>, <b>u+A</b>, <b>u+D</b>, <code><span style=display:inline-block;width:1ch> </span></code>, <code>#</code>, <code>/</code>, <code>:</code>, <code>&lt;</code>, <code>&gt;</code>, <code>?</code>, <code>@</code>, <code>[</code>, <code>\</code>, <code>]</code>, <code>^</code> }
      <!-- <tr><td>portchar <td> := <td> pchar \ { <code>@</code> } -->
    </table>
  </div>

  <h4>IPv6 Address</h4>
  <p>
    An IPv6 address-string <!--consists of a sequence of items, separated by
    <code>:</code> or <code>::</code>, the items being hexadecimal except for
    the last itme, which may consist of four decimal numbers separated by
    <code>.</code> as follows:-->
    is a <i class=common>string</i> representation of a natural number <var>n</var>Â &lt;Â 2<sup>128</sup>. 
    It is accurately described by the production rule <var>IPv6address</var>
    in the <a href=https://tools.ietf.org/html/rfc3986#section-3.2.2>Host</a>
    section of <abbr class=-caps>RFC</abbr> 3986. 


  <h3>URL Model</h3>
  <div class=todo>
    The grammar and the model, are very closely related. 
    (So close even that I'm pondering if I can merge them). 
    If you record the use of each rule whose name corresponds to 
    a token-type as a token, then you end up with an URL as defined in the Model section. 
    With the port, being once exception, and the definition of a host needs a bit of work too. 
  </div>

  <h3>A note about repeated slashes</h3>
    <p>
      This is a non-normative sub-section.

    <p>
      Web browsers interpret any amount of slashes after a 
      <i>web-scheme</i> as  the start of the authority component. Consider
      the following <span class=url>URL</span>-strings:

    <div class=-inbetween><ol class=-inline>
      <li><code>http:foo/bar</code>
      <li><code>http:/foo/bar</code>
      <li><code>http://foo/bar</code>
      <li><code>http:///foo/bar</code>
    </ol>.</div>

    <p>
      Web browsers treat all these examples as equivalent to
      <code>http://foo/bar</code>.
      It is tempting to try to express this behaviour on the level of the
      grammar. For example one might consider using the following rule:

    <p class="-inbetween -center">auth-path Â :=Â 
      <i>s</i>* <i>authority</i>
        [ <i>path-root</i> [ dir <i>s</i> ]* [ file ] ]

    <p>
      However, the examples above <em>do</em> behave differently with 
      respect to reference resolution. For example, if they are resolved 
      against the <i>base-<span class=url>URL</span></i> that is represented by
      <code>http://host/</code>, then the results are as follows:

    <div class=-inbetween><ol class=-inline>
      <li><code>http://host/foo/bar</code>
      <li><code>http://host/foo/bar</code>
      <li><code>http://foo/bar</code>
      <li><code>http://foo/bar</code>
    </ol>.</div>

    <p>
      As such, collapsing the multiples of slashes, cannot be expressed within 
      the grammar. Instead, the <i>force</i> operation as defined in the 
      section on <a href=#reference-resolution>Reference Resolution</a> implements this behaviour. 

</section>


<!------------------------------>
<section><h2>Host processing</h2>
<!------------------------------>

  <div class=todo>
    <ul>
      <li>Percent decode
      <li>Puny decode
      <li>Apply IDNA/ Nameprep normalisation
      <li>Detect IPv4 addresses
      <li>Err on forbidden host codepoints
    </ul>
  </div>

  <h4>IPv4 Address</h4>
  <p>
    An IPv4 address-string consists of one up to four dot-separated numbers with
    an optional trailing dot. The numbers may use decimal, octal or hexadecimal
    notation, as follows:

  <table class=grammar>
    <tr><td>ip4-address 
      <td> ::=
      <td> ip4num [<code>.</code> ip4num [<code>.</code> ip4num [<code>.</code> ip4num ] ] ] [<code>.</code>]
    <tr><td>ip4num 
      <td> ::= 
      <td> ip4dec | ip4octal | ip4hex
    <tr><td>ip4dec 
      <td> ::= 
      <td> <code>0</code> | (<i>digit-nonzero</i> <i>digit</i>*)
    <tr><td>ip4octal 
      <td> ::= 
      <td> <code>0</code> <i>octal-digit</i>*
    <tr><td>ip4hex 
      <td> ::= 
      <td> (<code>0x</code> | <code>0X</code>) <i>hex-digit</i>*
  </table>

  <p>
    Note that <code>0x</code> is parsed as a hexadecimal number.
    (It will be interpreted as 0).
</section>


<!----------------------------------->
<section><h2>Reference Resolution</h2>
<!----------------------------------->

  <p>
    This section defines a reference resolution operation that is analogous to
    the algorithm that is described in the chapter
    <a href="https://tools.ietf.org/html/rfc3986#section-5">Reference
    Resolution</a> of <abbr class=-caps>RFC</abbr> 3986. 
    The operations that are defined in this section are used in a subsequent
    chapter to accurately describe the behaviour of a
    <em>parse-resolve-and-normalise</em> algorithm that is referred to as the
    &ldquo;<a href="https://url.spec.whatwg.org/#concept-basic-url-parser">basic
      <span class=url>URL</span> parser</a>&rdquo;
    in the <abbr class=-caps>WHATWG URL</abbr> standard.
  <p>
    Reference Resolution as defined in this section does not involve
    <i><span class=url>URL</span>-string</i>s. It solely operates on
    <i class=url>URL</i>s as defined in the section
    <a href=#url-model><span class=url>URL</span> Model</a> above.
    In contrast with the previously
    mentioned sections in <abbr class=-caps>RFC</abbr> 3986 and in the
    <abbr class=-caps>WHATWG</abbr> standard, it does not do additional 
    normalisation, which is relegated to the section
    <a href=#equivalences-and-normalisation>Equivalences and Normalisation</a>
    instead.

  <h3>Order and Prefix operations</h3>

  <p>
    A property that is particularly useful is the <i>order</i> of an
    <span class=-nowrap><i class=url>URL</i>.</span>
    Colloquially, the <i class=common>order</i> is the
    <i class=common>type</i> of the first <i class=common>token</i>
    of an <i class=url>URL</i>. The <i class=common>order</i>
    may be used as an argument to specify various prefixes of an
    <i class=url>URL</i>.

  <div class="dfn-scope +br">
  <h4>The Order of an <span class=url>URL</span></h4>
    <p class=-br>
      The <dfn>order</dfn> of an <i class=url>URL</i> (<dfn class=fn>ord</dfn>
      <var>url</var>) is
      defined to be:
    <ul>
      <li>
        <b>fragment</b> if <var>url</var> is the empty <i class=url>URL</i>.
      <li>
        The <i class=common>type</i> of its first <i class=common>token</i>
        otherwise.
    </ul>

  <h4>Order-Limited Prefix</h4>
    <p class=-br>
      The <dfn>order-limited prefix</dfn>
      (<var>url</var> <dfn class=op>upto</dfn> <var>order</var>)
      is defined to be <br>
      the <em>shortest</em> prefix of <var>url</var> that contains:
      <ul>
        <li>
          all <i class=common>token</i>s of <em>url</em> with a
          <i class=common>type</i> strictly
          smaller than <var>order</var> and
        <li>
          all <b>dir</b> <i class=common>token</i>s with a
          <i class=common>type</i> weakly smaller
          than <var>order</var>.
    </ul>
  </div>

  <h3>Goto Operations</h3>
  <p>
    Based on the <i class=common>order</i> and the
    <i class=common>order-limited prefix</i> one can define
    &ldquo;<i class=common>goto</i>&rdquo; and
    &ldquo;<i class=common>non-strict goto</i>&rdquo; operations that are
    analogous to the &ldquo;merge&rdquo; operation and its non-strict
    counterpart that are defined in section
    <a href="https://tools.ietf.org/html/rfc3986#section-5.2.2">Transform
    References</a> of <abbr class=-caps>RFC</abbr> 3986.
  <br>
    I have chosen to rename &ldquo;merge&rdquo; to &ldquo;goto&rdquo; to avert
    the risk of incorrect assumptions about commutativity. 
    The operations are not commutative, but they are associative.

  <div class="dfn-scope">
  <h4>Goto</h4>
  <p>
    The <dfn>goto</dfn> operation
    (<var>url<sub>1</sub></var> <dfn class=op>goto</dfn>
     <var>url<sub>2</sub></var>) is defined to return
     <br>
    the <em>shortest</em> <i class=url>URL</i> that has
    <var>url<sub>1</sub></var> <b class=fn>upto</b>
    (<b class=fn>ord</b> <var>url<sub>2</sub></var>) as a
    prefix and <var>url<sub>2</sub></var> as a postfix.

  <h4>Non-Strict Goto</h4>
  <p class=-br>
    The <dfn>non-strict goto</dfn>
    (<var>url<sub>1</sub></var> <dfn class=op>~goto</dfn>
     <var>url<sub>2</sub></var>) is defined to be
     <br>
    (<var>url<sub>1</sub></var> <b class=op>goto</b> <var>url<sub>2</var>')
     where <var>url<sub>2</var>' is <var>url<sub>2</var> with its <b>scheme</b>
    <i class=common>token</i> removed if it case-insensitively compares equal
    to the <b>scheme</b> <i class=common>token</i> of <em>url<sub>1</sub></em>,
    or <em>url<sub>2</sub></em> otherwise.<br><br>
  </div>

  <h4>Goto Properties</h4>
  <p class=-br>
    The Goto operations have a number of pleasing mathematical properties, 
    as follows:
  <ul>
    <li>
      <i class=op>ord</i> (<var>url<sub>1</sub></var> <i class=op>goto</i>
        <var>url<sub>2</sub></var>) is the least type of
        {<i class=op>ord</i> <var>url<sub>1</sub></var>,
         <i class=op>ord</i> <var>url<sub>2</sub></var>}.
    <li>
      (<var>url<sub>1</sub></var> <i class=op>goto</i>
       <var>url<sub>2</sub></var>) <i class=op>goto</i>
       <var>url<sub>3</sub></var> = <var>url<sub>1</sub></var>
       <i class=op>goto</i> (<var>url<sub>2</sub></var> <i class=op>goto</i>
       <var>url<sub>3</sub></var>).
    <li>
      Îµ <i class=op>goto</i> <var>url<sub>2</sub></var> =
      <var>url<sub>2</sub></var>.
    <li>
      <var>url<sub>1</sub></var> <i class=op>goto</i> Îµ =
      <var>url<sub>1</sub></var> â€” if <var>url<sub>1</sub></var> does not
      have a <b>fragment</b>.
    <li>
      all of the above are true for <i class=op>~goto</i> as well.
    <li>
      <var>url<sub>2</sub></var> is a postfix of (<var>url<sub>1</sub></var>
      <i class=op>goto</i> <var>url<sub>2</sub></var>) but not necessarily of
      (<var>url<sub>1</sub></var> <i class=op>~goto</i>
      <var>url<sub>2</sub></var>).
  </ul>

  <p>
    Be aware that the <i>goto</i> operation does a bit more than 
    sequence concatenation. In some cases it creates a <b>path-root</b>
    token to satisfy the <i>path-root-constraint</i>
    of the <i class=url>URL</i> model. 
    An example can be useful. If <var>url<sub>1</sub></var> is the
    <i class=url>URL</i> that is represented by
    <code>//host</code> and <var>url<sub>2</sub></var> is the
    <i class=url>URL</i> represented
    by <code>foo/bar</code> then (<var>url<sub>1</sub></var> <i class=op>goto</i>
    <var>url<sub>2</sub></var>) is represented by
    <code>//host/foo/bar</code>, thus containing a <b>path-root</b> even though
    neither <var>url<sub>1</sub></var> nor <var>url<sub>2</sub></var> has 
    one.


  <h3>Forcing</h3>
  <p>
    There is an additional operation on <i class=url>URL</i>s called
    <dfn>force</dfn> that it is used as an error-recovery measure for
    <i>web-<span class=url>URL</span></i>s and for
    <i>file-<span class=url>URL</span></i>s.
    Force has no effect on other <i class=url>URL</i>s.

  <div class="dfn-scope +br">
  <h4>Forced File URL</h4>
    <p class=-br>
      To <dfn class=noindex>force</dfn> a <i>file-<span class=url>URL</span></i> <var>url</var>:
      <ul>
        <li>
          If <var>url</var> does not have an <b>authority</b> then set its
          <b>authority</b> token to 
          <span class=-nowrap>(<b>authority</b> Îµ)</span>.
        <li>
          If <var>url</var> does not have a <b>drive</b> then set its 
          <b>path-root</b> token to 
          <span class=-nowrap>(<b>path-root</b> <code>/</code>)</span>.
      </ul>
  </div>

  <div class="dfn-scope +br">
  <h4>Forced Web URL</h4>
    <p class=-br>
      To <dfn class=noindex>force</dfn> a <i>web-<span class=url>URL</span></i>
      <var>url</var>:
      <ul>
        <li>
          Set the <b>path-root</b> token of <var>url</var> to
          <span class=-nowrap>(<b>path-root</b> <code>/</code>)</span>.
        <li>
          If <var>url</var> has an <b>authority</b> token and the
          <i>value</i> of the token is is not Îµ
          â€” then return.
        <li>
          Otherwise let <var>token</var> be the first <b>dir</b> or
          <b>file</b> <i class=common>token</i> whose value is not Îµ. 
          If no such <i class=common>token</i> exists, <strong>fail</strong>.
        <li> 
          Remove all <b>dir</b> or <b>file</b> <i class=common>token</i>s that
          precede <var>token</var> and remove <var>token</var> as well. 
        <li>
          Let <var>auth</var> be the <i>value</i> of <var>token</var> parsed as
          an <i>Authority</i> and set the <b>authority</b> of <var>url</var> to
          <var>auth</var>. 
      </ul>
    </li>
  </div>
  <!--<div class=todo>
    Make this clean
  </div>-->

  <h4>Force Properties</h4>
  <p>
    The <i>force</i> operation has some unpleasant mathematical properties
    with respect to the <i>goto</i> operations. 
  <p class="-center -nowrap">
    <i class=op>force</i>
    ((<i class=op>force</i> <var>url<sub>1</sub></var>) Â <i class=op>goto</i>Â 
    (<i class=op>force</i> <var>url<sub>2</sub></var>)) Â â‰ Â  
    <i class=op>force</i> (<var>url<sub>1</sub></var> 
      Â <i class=op>goto</i>Â  <var>url<sub>2</sub></var>)
  <!-- <p class="-center -nowrap">
    <i class=op>force</i>
    (<var>url<sub>1</sub></var> Â <i class=op>goto</i>Â 
    (<i class=op>force</i> <var>url<sub>2</sub></var>)) Â â‰ Â 
    <i class=op>force</i> (<var>url<sub>1</sub></var>
      Â <i class=op>goto</i>Â  <var>url<sub>2</sub></var>) -->

<!-- force (url1  goto  (force url2))  â‰   force (url1  goto  url2)  -->

  <!-- <p>
    An example is the case where
    url1 is the URL that is represented by
    http:// -->

  <div class=todo>
    Clean up the definition a bit. 
    I may add a buch more inequalities here, too
  </div>


  <h3>Resolution</h3>
  <p>
    Based on the <i>goto</i> and <i>force</i> operations defined above,
    it is now possible to define a <i>resolution</i> operation that is
    compatible with the <abbr class=-caps>WHATWG</abbr> standard. 
    Note that resolution, defined as such, may return an <i class=url>URL</i> 
    that is not a <i>base-<span class=url>URL</span></i>.
    This is in accordance with the <abbr class=-caps>WHATWG</abbr> standard.

  <div class="dfn-scope +br">
    <dfn style=display:none>pre-resolve</dfn>
    <h4>Pre-Resolution</h4>
      <p class=-br>
        The <dfn>pre-resolution</dfn> of <var>url<sub>1</sub></var> against
        <var>url<sub>2</sub></var> is defined to be:
      <ul>
        <li>
          <var>url<sub>2</sub></var> <i class=op>~goto</i>
            <var>url<sub>1</sub></var>
          â€” if <var>url<sub>2</sub></var> is a
          <i>base-<span class=url>URL</span></i> or 
          <var>url<sub>1</sub></var>'s first token is a <b>fragment</b> token.
        <li>
          <var>url<sub>1</sub></var> â€” otherwise. 
    </ul>

    <dfn style=display:none>resolve</dfn>
    <h4>Resolution</h4>
    <p>
      The <dfn>resolution</dfn> of <var>url<sub>1</sub></var> against
      <var>url<sub>2</sub></var> is defined to be the <i>pre-resolution</i> of
      <var>url<sub>1</sub></var> against <var>url<sub>2</sub></var>
      â€” if its first <i class=common>token</i> is a <b>scheme</b>â€“ or a
      <b>fragment</b> token. Otherwise resolution <strong>fails</strong>. 
  </div>

  <div class="dfn-scope +br">
    <h4>Forced Resolution</h4>
    <dfn style=display:none>force-resolve</dfn>
    <p>
      The <dfn>forced resolution</dfn> of <var>url<sub>1</sub></var> against
      <var>url<sub>2</sub></var> is defined to be the <i>resolution</i> of 
      <var>url<sub>1</sub></var> against <var>url<sub>2</sub></var>, 
      subsequently <i>force</i>d. 
  </div>

</section>


<!--------------------------------------------->
<section><h2>Equivalences and Normalisation</h2>
<!--------------------------------------------->

<p>
  This section is analogous to the section
  <a href="https://tools.ietf.org/html/rfc3986#section-6.2">Normalization and 
  Comparison</a> of <abbr class=-caps>RFC</abbr> 3986. The
  <abbr class=-caps>RFC</abbr> however, does not <em>prescribe</em> a
  particular normal form. The <abbr class=-caps>WHATWG</abbr> standard
  does, however implicitly. 

<!-- <p>
  I think it is nice to define the equivalences via a congruence relation.
  The equations that follow in this section can be directed from left
  to right to obtain a set of terminating rewrite rules.
  An <i class=url>URL</i> is in normal form if no more rewrite rules can be
  applied.

<div class=todo>
  I like the idea of redefining the the concept of a normalisation function
  first, aligning it with mathematical practice. Thus, define it as a function
  that is congruent with the goto laws (this then,
  is &lsquo;URL algebra&rsquo;).
  I may have to do a little bit extra to point out the relationship between
  equivalence classes and normalisation.
  <ul>
  <li>norm ((norm url1) goto (norm url2)) = norm (url1 goto url2)
  <li>norm ((norm url1) ~goto (norm url2)) = norm (url1 ~goto url2)
  </ul>
  But I do want to keep things accessible, so not go in too deep here.
</div> -->


<h3>Path Segment Normalisation</h3>

<p>
  Path segment normalisation involves the interpretation of
  <i>dotted-segment</i>s. Colloquially, a single-dot segment has 
  the meaning of &ldquo;select the current directory&rdquo;
  whereas a double-dot segment has the meaning
  of &ldquo;select the parent directory&rdquo;. 
  Dotted segments are defined by the following rules, where
  the addition of <code>%2e</code> and <code>%2E</code> has been motivated
  by security concerns. Again this is in accordance with
  the <abbr class=-caps>WHATWG</abbr> standard.
</p>

<div class="dfn-scope +br">
<dfn style=display:none>dotted-segment</dfn>
<table class=grammar>
  <tr>
    <td><dfn>dot</dfn>
    <td> ::=
    <td colspan=10> <code>.</code> | <code>%2e</code> | <code>%2E</code>
  <tr>
    <td><dfn>dots</dfn> <td> ::= <td colspan=10> <i>dot</i>Â  <i>dot</i>
</table>
</div>

<p>
  Path equivalence is defined by the following equations.
  The equations must be exhaustively applied from left-to-right
  to normalise an <i class=url>URL</i>. 
</p>

<table class=grammar>
  <tr>
    <td><b>dir</b>  <var>x</var>
    <td> â‰ˆ <td>Îµ <td>â€”<td> if <var>x</var> :: <i>dot</i></td>
  <tr>
    <td><b>file</b> <var>x</var>
    <td> â‰ˆ <td>Îµ <td>â€”<td> if <var>x</var> :: <i>dot</i></td>
  <tr>
    <td><b>dir</b>  <var>x</var>ãƒ»<b>dir</b> <var>y</var>
    <td> â‰ˆ <td> Îµ                                
    <td> â€” <td> if <var>y</var> :: <i>dots</i> 
      and <strong>not</strong> <var>x</var> :: <i>dots</i>
  <tr>
    <td><b>dir</b>  <var>x</var>ãƒ»<b>file</b> <var>y</var>
    <td> â‰ˆ <td> Îµ                                
    <td> â€” <td> if <var>y</var> :: <i>dots</i> 
      and <strong>not</strong> <var>x</var> :: <i>dots</i>
  <tr>
    <td><b>path-root</b> <var>x</var>ãƒ»<b>dir</b> <var>y</var> 
    <td> â‰ˆ <td><b>path-root</b> <var>x</var>
    <td> â€” <td> if <var>y</var> :: <i>dots</i>
  <tr>
    <td><b>path-root</b> <var>x</var>ãƒ»<b>file</b> <var>y</var>
    <td> â‰ˆ <td><b>path-root</b> <var>x</var>
    <td> â€” <td> if <var>y</var> :: <i>dots</i>
</table>


<h3>Authority and Drive Letter Normalisation</h3>
<p>
  Authority equivalence is defined by the following equations.
  Like path normalisation,
  the equations must be exhaustively applied from left-to-right
  to normalise an <i class=url>URL</i>. 
</p>

  <table>
    <tr><td><b>username</b> Îµãƒ»<b>password</b> Îµ <td> â‰ˆ <td>Îµ
    <tr><td><b>password</b> Îµ <td> â‰ˆ <td>Îµ
    <tr><td><b>port</b> Îµ <td> â‰ˆ <td>Îµ
    <tr><td><b>drive</b>Â  <var>x</var><code>|</code>
      <td> â‰ˆ <td>
      <b>drive</b>Â  <var>x</var><code>:</code>
  </table>

<h3>Scheme-based Authority Normalisation</h3>
  <table>
    <tr>
      <td><b>scheme</b> <code>file</code> 
      <td>ãƒ»<td><b>authority</b> (<b>host</b> <code>localhost</code>)          
      <td> â‰ˆ <td> <b>scheme</b> <code>file</code> 
      <td>ãƒ»<td><b>authority</b> Îµ
    <tr>
      <td><b>scheme</b> <code>http</code> 
      <td>ãƒ»<td><b>authority</b> (<var>xs</var>ãƒ»<b>port</b> <code>80</code>)  
      <td> â‰ˆ <td> <b>scheme</b> <code>http</code> 
      <td>ãƒ»<td><b>authority</b> <var>xs</var>
    <tr>
      <td><b>scheme</b> <code>ws</code>   
      <td>ãƒ»<td><b>authority</b> (<var>xs</var>ãƒ»<b>port</b> <code>80</code>)  
      <td> â‰ˆ <td> <b>scheme</b> <code>ws</code>   
      <td>ãƒ»<td><b>authority</b> <var>xs</var>
    <tr>
      <td><b>scheme</b> <code>ftp</code>  
      <td>ãƒ»<td><b>authority</b> (<var>xs</var>ãƒ»<b>port</b> <code>21</code>)  
      <td> â‰ˆ <td> <b>scheme</b> <code>ftp</code>  
      <td>ãƒ»<td><b>authority</b> <var>xs</var>
    <tr>
      <td><b>scheme</b> <code>wss</code>  
      <td>ãƒ»<td><b>authority</b> (<var>xs</var>ãƒ»<b>port</b> <code>443</code>) 
      <td> â‰ˆ <td> <b>scheme</b> <code>wss</code>  
      <td>ãƒ»<td><b>authority</b> <var>xs</var>
    <tr>
      <td><b>scheme</b> <code>https</code>
      <td>ãƒ»<td><b>authority</b> (<var>xs</var>ãƒ»<b>port</b> <code>443</code>) 
      <td> â‰ˆ <td> <b>scheme</b> <code>https</code>
      <td>ãƒ»<td><b>authority</b> <var>xs</var>
  </table>

</section>



<!----------------------------->
<section><h2>Percent Coding</h2>
<!----------------------------->

<p>
  This section is analogous to the section 
  <a href="https://tools.ietf.org/html/rfc3986#section-2">Characters</a> 
  in <abbr class=-caps>RFC</abbr> 3986 and the section 
  <a href="https://url.spec.whatwg.org/#percent-encoded-bytes">Percent-encoded
    bytes</a> of the <abbr class=-caps>WHATWG</abbr> standard. 
  On an abstract level, <em>percent encoding</em> provides a means to use 
  use characters within <i class=common>token</i>s, that are not otherwise
  allowed by the <i class=url>URL</i> grammar.
  The <abbr class=-caps>WHATWG</abbr> standard <em>does not</em>
  specify the  semantics of percent-encoded-bytes in the components of an
  <i class=url>URL</i> other than in the host. 
  This effectively means that the interpretation of percent-encoded-bytes 
  in other <i class=common>token</i>s is left unspecified, and any
  percent-encoded bytes that are present <em>are not interpreted</em>.
  However, it does prescribe that certain characters must be <em>encoded</em>â€¦ 

<div class=todo>
  I'd like to see if there's a way to add
  this back in without breaking compatibility. Just making a mention of the
  semantics and prescribing a percent-encoding-normal-form could do. 
  It might be a better fit for the Normalisation section.
</div>
  
<p>
  The following defines the grammar for percent encoded strings.
</p>

<table class=grammar>
  <tr>
    <td>pct-encoded-string
    <td> ::=
    <td>(Â <i>pct-encoded-bytes</i> Â |Â  <i>pct-invalid</i> Â |Â  <i>uncoded</i>Â )*
  <tr>
    <td><dfn>pct-encoded-bytes</dfn>
    <td> ::=
    <td> <i>pct-encoded-byte</i>+
  <tr>
    <td><dfn>pct-encoded-byte</dfn>
    <td> ::=
    <td> <code>%</code> Â <i>hex-digit</i> Â <i>hex-digit</i>
  <tr>
    <td><dfn>pct-invalid</dfn>
    <td> ::=
    <td> <code>%</code> [ <i>hex-digit</i> ]
  <tr>
    <td><dfn>uncoded</dfn>
    <td> ::=
    <td> <i>non-pct</i>+
  <tr>
    <td><dfn>non-pct</dfn>
    <td> ::=
    <td> <i>any</i> \ { <code>%</code> }
</table>

<p>
  There is
    an ambiguity in this grammar due to the overlap between
    <i>pct-encoded-byte</i>
    and <i>pct-invalid</i> combined with <i>uncoded</i>. 
    This must be resolved by using the <i>pct-encoded-byte</i> rule instead of
    the <i>pct-invalid</i> rule whenever possible.


<h3>Percent Decoding Strings</h3>

<p>
  Percent decoding of strings is stratified into the following phases. 
<ul>
  <li>
    Analysing the string into <i>pct-encoded-bytes</i>, <i>pct-invalid</i> and 
    <i>uncoded</i> parts according to the grammar in the previous subsection.
  <li>
    Converting the percent-coded-bytes to sequences of unicode characters,
    whilst leaving the <i>pct-invalid</i> and <i>uncoded</i> parts unmodified.
  <li>
    Recomposing the string.
</ul>

<div class=todo>
  Wrap this up. 
  Also this needs to discuss encoding overrides. 
</div>


<h3>Percent Encoding Strings</h3>

<p>
  To <i>percent-encode</i> a <i class=common>string</i>, a set of 
  <i class=common>character</i>s must be provided as an argument to specify
  <em>which</em> <i class=common>character</i>s are to be
  <i>percent-encode</i>d. Such a set is called a <i>percent-encode-set</i>.

<h4>Percent Encode Set</h4>
  <p>
    A <dfn>percent-encode-set</dfn> is a subset of the
    <i class=common>printable-<abbr class=-caps>ASCII</abbr></i> characters
    that is used as a configuration argument to a
    <i>percent-encode</i> operation on <i>string</i>s.

<p class=todo>
  I'm not entirely sure about restricting the encode sets to printable ASCII. 
  In any case, the additional 'non-url codepoints' must be encoded. But It makes
  sense to mandate that and not make it configurable via the encode set.
  â€¦

<p class=todo>
  To <i>percent-encode</i> a given <i class=common>string</i> <var>string</var>,
  using a given <i class=common>percent-encode-set</i> <var>encode-set</var>,
  â€¦


<h3>Percent Encoding URLs</h3>

<p>
  Percent encoding can be extended from <i class=common>string</i>s to
  <i class=url>URL</i>s by percent encoding the tokens' 
  <i class=common>value</i>s of an <i class=url>URL</i>. This means that instead
  of a single <i class=common>percent-encode-set</i>,
  a <i>percent-encode-profile</i> is required as an argument to the
  percent-encode-operation on <i class=url>URL</i>s.

<h4>Percent Encode Profile</h4>
  <p>
    A <dfn>percent-encode-profile</dfn> is a mapping that maps 
    each <i>token-type</i> in the set 
    {Â <b>username</b>, <b>password</b>, <b>host</b>, <b>dir</b>,
      <b>file</b>, <b>query</b>, <b>fragment</b>Â } 
    to a <i>percent-encode-set</i>. 
    A <i class=common>percent-encode-profile</i> is used as a configuration
    argument to the <i>percent-encode</i> operation on <i class=url>URL</i>s.

<div class="dfn-scope +br">
<h4>Percent Encode Profiles</h4>
  <p>
  There are <em>four</em> distinct <i class=common>percent-encode-profile</i>s 
  that are relevant for this specification. 
  They are specified by the following tables. A table can be selected by
  clicking on one of the profile names below. 
<p class=-center>
  <dfn onclick="encodeTable.show({})">generic</dfn>,
  <dfn onclick="encodeTable.show({special:true})">special</dfn>,
  <dfn onclick="encodeTable.show({minimal:true})">minimal</dfn> and
  <dfn onclick="encodeTable.show({special:true, minimal:true})">minimal-special</dfn>.
</div>

<div id=percent-encode-sets class=+br><table>
  <col>
  <colgroup span=8>
  <colgroup span=1>
  <colgroup span=7>
  <colgroup span=6>
  <colgroup span=5>
  <tr>
    <th>
    <th colspan=8><b>u+20</b>â€“<b>u+27</b>
    <th colspan=1><!-- <b>u+2F</b> -->
    <th colspan=7><b>u+3A</b>â€“<b>u+40</b>
    <th colspan=6><b>u+5B</b>â€“<b>u+60</b>
    <th colspan=5><b>u+7B</b>â€“<b>u+7E</b>
    <th>
</table>
</div>

<script>

  const encodedTypes = ['username', 'password', 'host', 'dir', 'file', 'query', 'fragment']

  class EncodeTableView {

    constructor () {
      this.div = document.getElementById ('percent-encode-sets')
      this.template = this.div.firstChild
    }

    show ({ special = false, minimal = false } = { }) {
      const table = this.template.cloneNode (true)
      this.div.innerHTML = ''
      this.div.append (table)
      for (let name of encodedTypes) {
        const tr = $ ('tr', $('th', $('b', name, 'Â Â ')))
        for (let i=0x20; i<=0x7e; i++) {
          // remove 0-9, a-z, A-Z, '('-'.' and '$', '%' and '&'
          if ((i < 0x28 || i > 0x2e) && (i < 48 || i > 57) && (i < 65 || i > 90) && (i < 97 || i > 122)) {
            const _has = miniurl.isInSet (i, { name, minimal, special })
            const td = $('td', $('code', String.fromCharCode (i)))
              if (!_has) td.classList.add ('-screen')
              td.title = 'u+'+i.toString(16).toUpperCase ()
            tr.append(td)
          }
        }
        tr.append ($('td', 'Â Â '))
        table.append (tr)
      }
      let title = []
      if (minimal) title.push ('minimal')
      if (special) title.push ('special')
      title = title.join ('-')
      table.append ($('caption', title ? title : 'generic', ' ', 'percent encode profile'))
    }
  }

  const encodeTable = new EncodeTableView ()
  encodeTable.show ({ })

</script>

<p>
  Unfortunately, like parsing, the percent-encoding
  of <span class=url>URL</span>s is scheme dependent. 
  The consequence is that for scheme-less <span class=url>URL</span>s,
  a <i class=common>percent-encode-profile</i> must be manually specified. 

<h4>Encode Profile Selection</h4>
  <p>
    The <i>canonical-percent-encode-profile</i> for a given <i class=url>URL</i>
    <var>url</var> and a default profile <var>supplied-profile</var>
    is defined to be:
    <ul>
      <li>
        <i>special</i> â€” if <var>url</var> is a
        <i>file-<span class=url>URL</span></i> or if <var>url</var> is a
        <i>web-<span class=url>URL</span></i>,
      <li>
        <i>generic</i> â€” if otherwise <var>url</var> is a
        <i>base-<span class=url>URL</span></i>,
      <li>
        <i>minimal</i> â€” if otherwise <var>url</var> has a <b>scheme</b>, or
      <li>
        <var>supplied-profile</var> â€” otherwise. 
    </ul>


<div class=todo>
  Wrap this up. 
</div>

</section>


<!------------------------->
<section><h2>Validation</h2>
<!------------------------->

<p>
  The <abbr class=-caps>WHATWG</abbr> makes a distinction between
  <i class=noindex>validation-errors</i> and <i class=noindex>failures</i>.
  As such, the <em>validity</em> of an <span class=url>URL</span>
  is a three-state concept. There is accept, accepts-with-warnings, or reject. 
  This distinction can be made within the parser, the model, and the 
  operations. 

<div class=todo>
  This is work in progress
</div>

<h3>Parser</h3>
  <p>
    The parser <em>can</em> reject. There <em>are</em>
    <i class=common>string</i>s that are not <span class=url>URL</span>-strings.
    <br>This can happen within the <i>authority</i>, <i>port</i>, <i>host</i>
    and <i>ip6-address</i> rules. 

<p class=-br>
  It can accept with validation warnings,
<ul>
  <li>Invalid separator: backslash instead of slash
  <li>Drive letter preceded by <code>//</code>
  <li>Drive letter :: alpha <code>|</code> â€“ instead of
    alpha <code>:</code>
  <li>Invalid URL code points in tokens
  <li>Invalid escape sequences
  <li>Any credentials at all
</ul>
<p>It is possible to modify the grammar to arrive at a <em>strict</em>
  URL grammar, fairly easily.

<p>The host parser can reject on  (ao) invalid IPv4 address. 
  It can accept-with-warnings an IPv4 address that uses hexadecimal or octal
  notation.

<h3>Model</h3>
<p class=-br>The following validation warnings apply:</p>
<ul>
  <li>Presence of credentials; credentials are deprecated. 
  <li>Invalid URL code points in specific tokens. But I want to limit that,
    so that the model can be used to store unencoded strings. I think then,
    that this only applies to the host and the drive.
  <li>Web URL with empty authority. I will allow absent authorities though. 
    Failing on them is relegated to the Force and Resolve operations. 
  <li>Invalid percent sequences
</ul>

<h3>Operations</h3>
<p>
  This specification defines operations on <span class=url>URL</span>s that can
  fail.  These are the <i>force</i> operation, the <i>resolve</i> operation, and
  by reference, the <i>force-resolve</i> operation. 

<div class=todo>
  Whenever force needs to be employed, a validation warning should be issued. 
  That means, I will have to add a small step that detects if this is the case. 
  <br>
  Alright, it may be quite clean, to restrict the domain of these functions,
  and make that explicit, and then resort to forcing and recovery wherever 
  possible.
</div>

</section>


<!------------------------->
<section><h2>Printing</h2>
<!------------------------->
<p>
  Printing is the process of converting an <i class=url>URL</i> to an
  <i><span class=url>URL</span>-string</i>.


<div class=todo>
  <p>
    This is under development. 
  I like the idea of using a post-order traversal, or an algebraic fold,
  that seems most clean.
</div>

<ul>
  <li>
    To print to an <abbr class=-caps>ASCII</abbr>
    <i><span class=url>URL</span>-string</i>, 
    percent encode <i>any</i> \ <i>printable-<abbr class=-caps>ASCII</abbr></i>
  <li>
    Otherwise percent encode <i>control-c0</i>, <i>del-c1</i>, 
    <i>surrogate</i>s and <i>non-chars</i>. 
  <li>
    In addition percent encode a subset of 
    <i>printable-<abbr class=-caps>ASCII</abbr></i>, depending on the 
    <i class=common>token</i>, as indicated by the percent coding table. 
</ul>



<ul>
  <li>
    Let output be the empty string, then, for each of the
    <i class=common>token</i>s (<var>tag</var>, <var>value</var>) of
    <var>url2</var> in tree order, convert the <i class=common>token</i> to a
    <i class=common>string</i>, depending on its <i>type</i> according to the
    following table, and append it to the output.
</ul>

<table id=printer>
  <tr>
  <th><b>scheme</b>
  <th colspan=2><b>authority</b>
  <th><b>drive</b>
  <th><b>root</b>
  <th><b>dir</b>
  <th><b>file</b>
  <th><b>query</b>
  <th><b>fragment</b>
  <tr>
  <td><var>value</var> <code>:</code>
  <td><code>//</code><td><table>
    <tr><th colspan=2>credentials<th><b>host</b><th><b>port</b>
    <tr><td><table>
      <tr><th><b>user</b><th><b>pass</b>
      <tr><td><var>value</var><td><var> <code>:</code> value</var>
    </table><td><code>@</code>
      <td><var>value</var><td><var><code>:</code> value</var>
    </table>
  <td><code>/</code> <var>value</var>
  <td><code>/</code>
  <td><var>value</var> <code>/</code>
  <td><var>value</var>
  <td><code>?</code> <var>value</var>
  <td><code>#</code> <var>value</var>
</table>
</section>


</body>
</html>